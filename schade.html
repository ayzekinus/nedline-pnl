<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kaza Takip - MVP Demo</title>
 <style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --muted:#5b6b86;
    --text:#0f172a;
    --line:#e5e7eb;
    --btn:#2563eb;
  }

  body{
    margin:0;
    font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background:var(--bg);
    color:var(--text);
  }

  header{
    padding:16px 20px;
    border-bottom:1px solid var(--line);
    display:flex;
    gap:12px;
    align-items:center;
    background:var(--card);
  }

  .wrap{
    display:grid;
    grid-template-columns: 360px 1fr;
    gap:16px;
    padding:16px;
  }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:14px;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
  }

  .muted{ color:var(--muted); font-size:12px; }

  input, select, textarea, button{
    width:100%;
    box-sizing:border-box;
    border-radius:10px;
    border:1px solid var(--line);
    background:#ffffff;
    color:var(--text);
    padding:10px;
  }

  textarea{ min-height:74px; resize:vertical; }

  button{
    background:var(--btn);
    border:none;
    font-weight:650;
    cursor:pointer;
    color:#ffffff;
  }

  button.secondary{
    background:#ffffff;
    border:1px solid var(--line);
    color:var(--text);
  }

  .item{
    padding:10px;
    border:1px solid var(--line);
    border-radius:12px;
    cursor:pointer;
    background:#ffffff;
  }

  .item:hover{ border-color:#93c5fd; }

  .pill{
    display:inline-block;
    padding:2px 8px;
    border:1px solid var(--line);
    border-radius:999px;
    font-size:11px;
    margin-left:6px;
    color:var(--muted);
    background:#f9fafb;
  }

  .tbl{ width:100%; border-collapse:collapse; font-size:13px; }
  .tbl th,.tbl td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; vertical-align:top; }

  .danger{ background:#dc2626; color:#fff; }
  .ok{ background:#16a34a; color:#fff; }

  .tag{
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    display:inline-block;
  }

   /* Mobil uyumluluk */
.headerActions{
  margin-left:auto;
  display:flex;
  gap:8px;
}

.actions{
  display:flex;
  gap:8px;
}

.tableWrap{
  overflow-x:auto;
  -webkit-overflow-scrolling: touch;
  border-radius: 12px;
}

/* Tablet ve altı: iki kolon -> tek kolon */
@media (max-width: 980px){
  .wrap{
    grid-template-columns: 1fr;
    padding:12px;
  }

  header{
    flex-wrap: wrap;
    gap:10px;
    position: sticky;
    top:0;
    z-index:10;
  }

  .headerActions{
    width:100%;
    margin-left:0;
    justify-content:flex-start;
    flex-wrap: wrap;
  }

  .headerActions button{
    width:auto;
  }
}

/* Mobil: formlar ve bölümler tek kolona, butonlar satıra kırılır */
@media (max-width: 700px){
  .row{
    grid-template-columns: 1fr;
  }

  .grid2,
  .split{
    grid-template-columns: 1fr;
  }

  .actions{
    flex-wrap: wrap;
  }

  .actions button{
    flex: 1;
    min-width: 140px;
  }

  /* iOS input zoom engeli + daha iyi okunabilirlik */
  input, select, textarea, button{
    font-size: 16px;
  }

  /* Kart iç boşlukları mobilde daha rahat */
  .card{
    padding:12px;
  }
}

</style>

</head>
<body>
  <header>
    <h1>Kaza Takip – MVP Demo</h1>
    <span class="muted">LocalStorage tabanlı örnek</span>
    
    <div style="margin-left:auto; display:flex; gap:8px;">
      <div class="headerActions">
      <button class="secondary" onclick="exportData()">Export JSON</button>
      <button class="secondary" onclick="importData()">Import JSON</button>
      <button class="secondary danger" onclick="resetAll()">Sıfırla</button>
    </div>
  </header>

  <div class="wrap">
    <!-- LEFT: LIST + CREATE -->
    <div class="card">
      <h2 class="sectionTitle">Kaza Listesi</h2>
      <div class="row">
        <input id="q" placeholder="Ara (plaka, sürücü, case no)..." oninput="renderList()" />
        <select id="fStatus" onchange="renderList()">
          <option value="">Tümü</option>
          <option value="OPEN">Açık</option>
          <option value="IN_REVIEW">İncelemede</option>
          <option value="CLOSED">Kapalı</option>
        </select>
      </div>
      <div style="height:10px"></div>
      <div id="list" class="list"></div>

      <div style="height:14px"></div>
      <h2 class="sectionTitle">Yeni Kaza Oluştur</h2>
      <div class="row">
        <input id="branch" placeholder="Şube (örn. Oude Meer)" />
        <select id="severity">
          <option value="LOW">Düşük</option>
          <option value="MEDIUM" selected>Orta</option>
          <option value="HIGH">Yüksek</option>
        </select>
      </div>
      <div class="row">
        <input id="plate" placeholder="Plaka (örn. NL-AB-123)" />
        <input id="vehicleNo" placeholder="Araç No (örn. TRK-014)" />
      </div>
      <div class="row">
        <input id="driverName" placeholder="Sürücü Adı" />
        <input id="eventAt" type="datetime-local" />
      </div>
      <div class="row">
        <select id="accidentType">
          <option value="REAR_END">Arkadan Çarpma</option>
          <option value="SIDE">Yandan</option>
          <option value="PARKING">Park / Manevra</option>
          <option value="SINGLE">Tek Taraf</option>
          <option value="LOAD_DAMAGE">Yük Hasarı</option>
        </select>
        <select id="police">
          <option value="false">Polis Yok</option>
          <option value="true">Polis Var</option>
        </select>
      </div>
      <textarea id="desc" placeholder="Kısa açıklama..."></textarea>
      <div style="height:10px"></div>
      <div class="actions">
        <button onclick="createCase()">Kaydet</button>
        <button class="secondary" onclick="fillWithNow()">Şimdi</button>
        <button class="secondary" onclick="getLocation()">Konum Al</button>
      </div>
      <div class="muted" id="locHint" style="margin-top:8px;"></div>
    </div>

    <!-- RIGHT: DETAILS -->
    <div class="card">
      <div id="detailEmpty" class="muted">
        Soldan bir kaza seçin veya yeni kaza oluşturun.
      </div>

      <div id="detail" style="display:none;">
        <div style="display:flex; align-items:flex-start; gap:12px;">
          <div style="flex:1;">
            <h2 style="margin:0; font-size:16px;" id="dTitle"></h2>
            <div class="muted" id="dMeta"></div>
          </div>
          <div style="display:flex; gap:8px;">
            <select id="dStatus" onchange="updateStatus()">
              <option value="OPEN">Açık</option>
              <option value="IN_REVIEW">İncelemede</option>
              <option value="CLOSED">Kapalı</option>
            </select>
            <button class="secondary" onclick="deleteCase()">Sil</button>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="grid2">
          <div class="card" style="padding:12px;">
            <h3 class="sectionTitle">Özet</h3>
            <div class="small" id="dSummary"></div>
          </div>
          <div class="card" style="padding:12px;">
            <h3 class="sectionTitle">Konum</h3>
            <div class="small" id="dLocation"></div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="split">
          <div class="card" style="padding:12px;">
            <h3 class="sectionTitle">Görevler</h3>
            <div class="row">
              <input id="tTitle" placeholder="Görev başlığı" />
              <input id="tDue" type="date" />
            </div>
            <div class="row">
              <input id="tAssignee" placeholder="Atanan (örn. Operasyon)" />
              <button onclick="addTask()">Görev Ekle</button>
            </div>
            <div style="height:8px"></div>
            <div class="tableWrap">
            <table class="tbl">
              <thead><tr><th>Başlık</th><th>Atanan</th><th>Son Tarih</th><th class="right">Durum</th></tr></thead>
              <tbody id="tBody"></tbody>
            </table>
          </div>

          <div class="card" style="padding:12px;">
            <h3 class="sectionTitle">Maliyetler</h3>
            <div class="row">
              <select id="cType">
                <option value="REPAIR">Onarım</option>
                <option value="TOWING">Çekici</option>
                <option value="PARKING">Otopark</option>
                <option value="REPLACEMENT">İkame</option>
                <option value="PENALTY">Ceza</option>
                <option value="THIRD_PARTY">3. Taraf</option>
              </select>
              <input id="cAmount" type="number" step="0.01" placeholder="Tutar (EUR)" />
            </div>
            <div class="row">
              <input id="cSupplier" placeholder="Tedarikçi" />
              <input id="cInvoice" placeholder="Fatura No" />
            </div>
            <button onclick="addCost()">Maliyet Ekle</button>
            <div style="height:8px"></div>
            <div class="tableWrap">
            <table class="tbl">
              <thead><tr><th>Tür</th><th>Tedarikçi</th><th>Fatura</th><th class="right">Tutar</th></tr></thead>
              <tbody id="cBody"></tbody>
              <tfoot><tr><td colspan="3" class="right"><b>Toplam</b></td><td class="right" id="cTotal"></td></tr></tfoot>
            </table>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="split">
          <div class="card" style="padding:12px;">
            <h3 class="sectionTitle">Ekler (Foto/Dosya)</h3>
            <div class="row">
              <select id="aType">
                <option value="PHOTO">Foto</option>
                <option value="VIDEO">Video</option>
                <option value="REPORT">Tutanak / PDF</option>
                <option value="INVOICE">Fatura</option>
                <option value="OTHER">Diğer</option>
              </select>
              <input id="aFile" type="file" />
            </div>
            <button onclick="addAttachment()">Yükle</button>
            <div class="muted" style="margin-top:6px;">Demo: Dosyayı base64 olarak kaydeder (sınırlı).</div>
            <div style="height:8px"></div>
            <div class="tableWrap">
            <table class="tbl">
              <thead><tr><th>Tür</th><th>Dosya</th><th>Tarih</th><th class="right">İşlem</th></tr></thead>
              <tbody id="aBody"></tbody>
            </table>
          </div>

          <div class="card" style="padding:12px;">
            <h3 class="sectionTitle">Timeline</h3>
         <div class="tableWrap">   
            <table class="tbl">
              <thead><tr><th>Tarih</th><th>Kim</th><th>Olay</th></tr></thead>
              <tbody id="lBody"></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
  const STORAGE_KEY = "accident_cases_v1";
  let state = { cases: [], selectedId: null, draftLocation: null };

  function load() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      state.cases = JSON.parse(raw);
    } else {
      seed();
      save();
    }
    renderList();
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.cases));
  }

  function nowIsoLocal() {
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,16);
  }

  function seed() {
    state.cases = [{
      id: "CASE-2026-0001",
      status: "OPEN",
      severity: "MEDIUM",
      branch: "Oude Meer",
      eventAt: "2026-01-02T09:15",
      reportedAt: "2026-01-02T09:22",
      location: { lat: 52.3031, lon: 4.7639, address: "1438AN Oude Meer, Netherlands" },
      accidentType: "REAR_END",
      injury: false,
      police: true,
      description: "Trafikte ani fren sonucu arkadan çarpma.",
      vehicle: { plate: "NL-AB-123", vehicleNo: "TRK-014", trailerNo: "TRL-209" },
      driver: { name: "Ahmet Yılmaz", employeeId: "EMP-1021", phone: "" },
      thirdParty: { name: "", plate: "", phone: "", insurer: "" },
      attachments: [],
      tasks: [
        { id:"TSK-1", title:"Tutanak yükle", assignee:"Operasyon", dueAt:"2026-01-03", status:"OPEN" }
      ],
      costs: [
        { id:"CST-1", type:"TOWING", amount:220.0, currency:"EUR", supplier:"TowCo", invoiceNo:"TW-5512" }
      ],
      timeline: [
        { at:"2026-01-02T09:22", by:"Driver", event:"Case created" }
      ]
    }];
  }

  function nextCaseId() {
    const year = new Date().getFullYear();
    const n = state.cases.length + 1;
    return `CASE-${year}-${String(n).padStart(4,'0')}`;
  }

  function renderList() {
    const q = (document.getElementById("q").value || "").toLowerCase().trim();
    const fStatus = document.getElementById("fStatus").value;
    const list = document.getElementById("list");

    const filtered = state.cases
      .filter(c => !fStatus || c.status === fStatus)
      .filter(c => {
        if (!q) return true;
        const hay = [
          c.id, c.branch, c.vehicle?.plate, c.vehicle?.vehicleNo, c.driver?.name, c.description
        ].join(" ").toLowerCase();
        return hay.includes(q);
      })
      .sort((a,b) => (b.reportedAt || "").localeCompare(a.reportedAt || ""));

    list.innerHTML = filtered.map(c => {
      const statusTag = c.status === "CLOSED" ? "ok" : (c.status === "IN_REVIEW" ? "" : "danger");
      const statusLabel = c.status === "OPEN" ? "Açık" : (c.status === "IN_REVIEW" ? "İncelemede" : "Kapalı");
      return `
        <div class="item" onclick="selectCase('${c.id.replaceAll("'","")}')">
          <div><b>${c.id}</b> <span class="tag ${statusTag}">${statusLabel}</span>
            <span class="pill">${c.severity}</span>
          </div>
          <div class="muted">${c.vehicle?.plate || "-"} • ${c.driver?.name || "-"} • ${c.branch || "-"}</div>
          <div class="muted">Olay: ${fmtDT(c.eventAt)} • Bildirim: ${fmtDT(c.reportedAt)}</div>
        </div>
      `;
    }).join("") || `<div class="muted">Kayıt bulunamadı.</div>`;
  }

  function fmtDT(s) {
    if (!s) return "-";
    return s.replace("T", " ");
  }

  function fillWithNow() {
    document.getElementById("eventAt").value = nowIsoLocal();
  }

  function getLocation() {
    const hint = document.getElementById("locHint");
    hint.textContent = "Konum alınıyor...";
    if (!navigator.geolocation) {
      hint.textContent = "Tarayıcı konum servisleri desteklemiyor.";
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        state.draftLocation = {
          lat: Number(pos.coords.latitude.toFixed(6)),
          lon: Number(pos.coords.longitude.toFixed(6)),
          address: "—"
        };
        hint.textContent = `Konum alındı: ${state.draftLocation.lat}, ${state.draftLocation.lon}`;
      },
      () => { hint.textContent = "Konum alınamadı (izin verilmemiş olabilir)."; },
      { enableHighAccuracy: true, timeout: 8000 }
    );
  }

  function createCase() {
    const branch = document.getElementById("branch").value.trim();
    const severity = document.getElementById("severity").value;
    const plate = document.getElementById("plate").value.trim();
    const vehicleNo = document.getElementById("vehicleNo").value.trim();
    const driverName = document.getElementById("driverName").value.trim();
    const eventAt = document.getElementById("eventAt").value || nowIsoLocal();
    const accidentType = document.getElementById("accidentType").value;
    const police = document.getElementById("police").value === "true";
    const desc = document.getElementById("desc").value.trim();

    if (!plate || !driverName) {
      alert("Plaka ve Sürücü Adı zorunludur.");
      return;
    }

    const id = nextCaseId();
    const reportedAt = nowIsoLocal();
    const c = {
      id,
      status: "OPEN",
      severity,
      branch,
      eventAt,
      reportedAt,
      location: state.draftLocation || { lat:null, lon:null, address:"—" },
      accidentType,
      injury: false,
      police,
      description: desc,
      vehicle: { plate, vehicleNo, trailerNo:"" },
      driver: { name: driverName, employeeId:"", phone:"" },
      thirdParty: { name:"", plate:"", phone:"", insurer:"" },
      attachments: [],
      tasks: [],
      costs: [],
      timeline: [
        { at: reportedAt, by: "User", event: "Case created" }
      ]
    };

    state.cases.push(c);
    save();
    renderList();
    selectCase(id);

    // reset create form
    document.getElementById("desc").value = "";
  }

  function selectCase(id) {
    state.selectedId = id;
    const c = state.cases.find(x => x.id === id);
    if (!c) return;

    document.getElementById("detailEmpty").style.display = "none";
    document.getElementById("detail").style.display = "block";

    document.getElementById("dTitle").textContent = `${c.id} • ${c.vehicle?.plate || "-"}`;
    document.getElementById("dMeta").textContent = `Şube: ${c.branch || "-"} • Olay: ${fmtDT(c.eventAt)} • Bildirim: ${fmtDT(c.reportedAt)}`;

    document.getElementById("dStatus").value = c.status;

    document.getElementById("dSummary").innerHTML = `
      <div><b>Sürücü:</b> ${c.driver?.name || "-"}</div>
      <div><b>Araç No:</b> ${c.vehicle?.vehicleNo || "-"}</div>
      <div><b>Tip:</b> ${labelType(c.accidentType)} | <b>Polis:</b> ${c.police ? "Var" : "Yok"}</div>
      <div style="margin-top:6px;"><b>Açıklama:</b><br>${escapeHtml(c.description || "-")}</div>
    `;

    const loc = c.location || {};
    document.getElementById("dLocation").innerHTML = `
      <div><b>Adres:</b> ${escapeHtml(loc.address || "—")}</div>
      <div><b>Koordinat:</b> ${loc.lat ?? "—"}, ${loc.lon ?? "—"}</div>
    `;

    renderTasks(c);
    renderCosts(c);
    renderAttachments(c);
    renderTimeline(c);
  }

  function labelType(t) {
    return ({
      REAR_END:"Arkadan Çarpma",
      SIDE:"Yandan",
      PARKING:"Park / Manevra",
      SINGLE:"Tek Taraf",
      LOAD_DAMAGE:"Yük Hasarı"
    })[t] || t;
  }

  function escapeHtml(s) {
    return (s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function updateStatus() {
    const c = getSelected();
    if (!c) return;
    const val = document.getElementById("dStatus").value;
    c.status = val;
    c.timeline.unshift({ at: nowIsoLocal(), by: "User", event: `Status changed to ${val}` });
    save();
    renderList();
    selectCase(c.id);
  }

  function deleteCase() {
    const c = getSelected();
    if (!c) return;
    if (!confirm(`${c.id} silinsin mi?`)) return;
    state.cases = state.cases.filter(x => x.id !== c.id);
    save();
    state.selectedId = null;
    document.getElementById("detail").style.display = "none";
    document.getElementById("detailEmpty").style.display = "block";
    renderList();
  }

  function getSelected() {
    return state.cases.find(x => x.id === state.selectedId);
  }

  function addTask() {
    const c = getSelected();
    if (!c) return;

    const title = document.getElementById("tTitle").value.trim();
    const dueAt = document.getElementById("tDue").value;
    const assignee = document.getElementById("tAssignee").value.trim();

    if (!title) { alert("Görev başlığı zorunlu."); return; }

    const id = `TSK-${(c.tasks.length + 1)}`;
    c.tasks.push({ id, title, assignee, dueAt, status:"OPEN" });
    c.timeline.unshift({ at: nowIsoLocal(), by: "User", event: `Task added: ${title}` });

    document.getElementById("tTitle").value = "";
    document.getElementById("tAssignee").value = "";
    save();
    renderTasks(c);
    renderTimeline(c);
  }

  function toggleTask(id) {
    const c = getSelected(); if (!c) return;
    const t = c.tasks.find(x => x.id === id); if (!t) return;
    t.status = (t.status === "OPEN") ? "DONE" : "OPEN";
    c.timeline.unshift({ at: nowIsoLocal(), by: "User", event: `Task ${t.status}: ${t.title}` });
    save();
    renderTasks(c);
    renderTimeline(c);
  }

  function renderTasks(c) {
    const body = document.getElementById("tBody");
    body.innerHTML = c.tasks.map(t => `
      <tr>
        <td>${escapeHtml(t.title)}</td>
        <td>${escapeHtml(t.assignee || "-")}</td>
        <td>${t.dueAt || "-"}</td>
        <td class="right">
          <button class="secondary" onclick="toggleTask('${t.id}')">${t.status === "DONE" ? "Tamam" : "Açık"}</button>
        </td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="muted">Görev yok.</td></tr>`;
  }

  function addCost() {
    const c = getSelected();
    if (!c) return;

    const type = document.getElementById("cType").value;
    const amount = Number(document.getElementById("cAmount").value);
    const supplier = document.getElementById("cSupplier").value.trim();
    const invoiceNo = document.getElementById("cInvoice").value.trim();

    if (!amount || amount <= 0) { alert("Geçerli bir tutar girin."); return; }

    const id = `CST-${(c.costs.length + 1)}`;
    c.costs.push({ id, type, amount, currency:"EUR", supplier, invoiceNo });
    c.timeline.unshift({ at: nowIsoLocal(), by: "User", event: `Cost added: ${type} ${amount} EUR` });

    document.getElementById("cAmount").value = "";
    document.getElementById("cSupplier").value = "";
    document.getElementById("cInvoice").value = "";
    save();
    renderCosts(c);
    renderTimeline(c);
  }

  function renderCosts(c) {
    const body = document.getElementById("cBody");
    const total = c.costs.reduce((s,x) => s + (Number(x.amount)||0), 0);
    document.getElementById("cTotal").textContent = `${total.toFixed(2)} EUR`;

    body.innerHTML = c.costs.map(x => `
      <tr>
        <td>${escapeHtml(x.type)}</td>
        <td>${escapeHtml(x.supplier || "-")}</td>
        <td>${escapeHtml(x.invoiceNo || "-")}</td>
        <td class="right">${Number(x.amount).toFixed(2)} ${x.currency || "EUR"}</td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="muted">Maliyet yok.</td></tr>`;
  }

  function addAttachment() {
    const c = getSelected();
    if (!c) return;

    const type = document.getElementById("aType").value;
    const fileInput = document.getElementById("aFile");
    const f = fileInput.files[0];
    if (!f) { alert("Dosya seçin."); return; }

    const reader = new FileReader();
    reader.onload = () => {
      const id = `ATT-${(c.attachments.length + 1)}`;
      c.attachments.push({
        id, type, name: f.name, createdAt: nowIsoLocal(),
        dataUrl: reader.result // demo
      });
      c.timeline.unshift({ at: nowIsoLocal(), by: "User", event: `Attachment uploaded: ${f.name}` });
      fileInput.value = "";
      save();
      renderAttachments(c);
      renderTimeline(c);
    };
    reader.readAsDataURL(f);
  }

  function downloadAttachment(attId) {
    const c = getSelected(); if (!c) return;
    const a = c.attachments.find(x => x.id === attId); if (!a) return;
    const link = document.createElement("a");
    link.href = a.dataUrl;
    link.download = a.name;
    link.click();
  }

  function removeAttachment(attId) {
    const c = getSelected(); if (!c) return;
    c.attachments = c.attachments.filter(x => x.id !== attId);
    c.timeline.unshift({ at: nowIsoLocal(), by: "User", event: `Attachment removed: ${attId}` });
    save();
    renderAttachments(c);
    renderTimeline(c);
  }

  function renderAttachments(c) {
    const body = document.getElementById("aBody");
    body.innerHTML = c.attachments.map(a => `
      <tr>
        <td>${escapeHtml(a.type)}</td>
        <td>${escapeHtml(a.name)}</td>
        <td>${fmtDT(a.createdAt)}</td>
        <td class="right">
          <button class="secondary" onclick="downloadAttachment('${a.id}')">İndir</button>
          <button class="secondary" onclick="removeAttachment('${a.id}')">Sil</button>
        </td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="muted">Ek yok.</td></tr>`;
  }

  function renderTimeline(c) {
    const body = document.getElementById("lBody");
    const items = (c.timeline || []).slice().sort((a,b) => (b.at||"").localeCompare(a.at||""));
    body.innerHTML = items.map(e => `
      <tr>
        <td>${fmtDT(e.at)}</td>
        <td>${escapeHtml(e.by || "-")}</td>
        <td>${escapeHtml(e.event || "-")}</td>
      </tr>
    `).join("") || `<tr><td colspan="3" class="muted">Timeline boş.</td></tr>`;
  }

  function exportData() {
    const blob = new Blob([JSON.stringify(state.cases, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "kaza-takip-export.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  function importData() {
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = () => {
      const f = inp.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = () => {
        try {
          const data = JSON.parse(r.result);
          if (!Array.isArray(data)) throw new Error("Format geçersiz (array bekleniyor).");
          state.cases = data;
          save();
          state.selectedId = null;
          document.getElementById("detail").style.display = "none";
          document.getElementById("detailEmpty").style.display = "block";
          renderList();
          alert("Import tamamlandı.");
        } catch (e) {
          alert("Import hatası: " + e.message);
        }
      };
      r.readAsText(f);
    };
    inp.click();
  }

  function resetAll() {
    if (!confirm("Tüm veriler silinsin mi?")) return;
    localStorage.removeItem(STORAGE_KEY);
    state = { cases: [], selectedId: null, draftLocation: null };
    load();
    alert("Sıfırlandı.");
  }

  load();
</script>
</body>
</html>
