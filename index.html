<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NedLine MVP - Drivers/Contracts/Tours/Routes</title>
  <style>
    :root { --b:#e6e6e6; --bg:#fafafa; --txt:#111; --muted:#666; --card:#fff; --shadow: 0 6px 18px rgba(0,0,0,.06); }
    body{ font-family: Arial, sans-serif; margin:18px; color:var(--txt); background:#fff; }
    h1{ margin:0 0 6px; font-size:20px; }
    .muted{ color:var(--muted); font-size:12px; line-height:1.4; }
    .topbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:12px 0 14px; }
    .tabbar{ display:flex; gap:8px; flex-wrap:wrap; }
    .tabbar button{
      border:1px solid var(--b); background:var(--bg); padding:10px 12px; border-radius:12px; cursor:pointer;
      font-size:13px;
    }
    .tabbar button.active{ background:#111; color:#fff; border-color:#111; }
    .card{ border:1px solid var(--b); border-radius:14px; padding:14px; margin-top:12px; background:var(--card); box-shadow: var(--shadow); }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; }
    label{ font-size:12px; }
    input, select, textarea{
      border:1px solid var(--b); border-radius:10px; padding:8px 10px; font-size:13px; background:#fff;
    }
    textarea{ min-height:80px; width:100%; }
    button{
      border:1px solid var(--b); background:var(--bg); padding:10px 12px; border-radius:12px; cursor:pointer;
      font-size:13px;
    }
    button.primary{ background:#111; color:#fff; border-color:#111; }
    button.primary:hover{ background:#000; }
    button.danger{ background:#fff3f3; border-color:#ffd0d0; }
    button:hover{ background:#f0f0f0; }
    hr{ border:0; border-top:1px solid #eee; margin:12px 0; }
    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th, td{ border:1px solid #eee; padding:8px; font-size:12px; vertical-align:top; }
    th{ background:#fbfbfb; text-align:left; position:sticky; top:0; z-index:1; }
    .right{ text-align:right; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--b); font-size:12px; background:#fff; }
    .scroller{ overflow:auto; max-height:520px; border:1px solid #eee; border-radius:12px; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px; }
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:14px;
      z-index: 9999;
    }
    .modal{
      background:#fff; border-radius:14px; border:1px solid #eee; padding:14px; width:min(980px, 100%);
      box-shadow: 0 20px 60px rgba(0,0,0,.2);
    }
    .modal h3{ margin:0 0 8px; }
    .small{ font-size:11px; color:var(--muted); }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media(max-width:980px){ .grid2{ grid-template-columns:1fr; } }
    .hint{ background:#fff; border:1px dashed #ddd; border-radius:12px; padding:10px; }
  </style>
</head>
<body>

<h1>NedLine MVP — Sürücüler / Sözleşmeler / Turlar / Rotalar</h1>
<div class="muted">
  Rota mantığı: Turlardan seçim yaparak <b>NED001</b> gibi rota oluşturursunuz. Tur fiyatı “alış”, rota satış fiyatı ayrıca girilir.
  TLN/ZZP sürücü atanırsa sözleşme saat ücretinden maliyet otomatik hesaplanır (gece + hafta sonu primleri dahil).
</div>

<div class="topbar">
  <div class="tabbar" id="tabs"></div>
  <div style="flex:1"></div>
  <div class="row">
    <button id="btnExport">Yedek (JSON) Dışa Aktar</button>
    <button id="btnImport">Yedek (JSON) İçe Aktar</button>
    <button class="danger" id="btnReset">Tüm Veriyi Sıfırla</button>
  </div>
</div>

<div id="view"></div>
<input type="file" id="fileInput" style="display:none" accept=".json"/>

<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="row">
      <h3 id="modalTitle" style="margin:0;">Görüntüle</h3>
      <div style="flex:1"></div>
      <button id="modalClose">Kapat</button>
    </div>
    <div id="modalBody" style="margin-top:10px;"></div>
  </div>
</div>

<script>
/* =========================
   Storage / State
   ========================= */
const STORAGE_KEY = "nedline_mvp_v1_drivers_contracts_tours_routes";

const PROFILE_TYPES = [
  {code:"EMPLOYEE_TLN", label:"Employe TLN"},
  {code:"ZZP_HOURLY", label:"ZZP HOURLY"},
  {code:"CHARTER_KM", label:"CHARTER KM"},
  {code:"CHARTER_HOUR", label:"CHARTER HOUR"},
  {code:"CHARTER_FIXED", label:"CHARTER FIXED"}
];

const ROUTE_DRIVER_MODE = [
  {code:"TLN", label:"TLN Sözleşmeli Sürücü"},
  {code:"ZZP", label:"ZZP Sürücü"},
  {code:"CHARTER", label:"Charter"}
];

const esc = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const num = (x) => {
  if (x === null || x === undefined) return 0;
  const s = String(x).trim().replace(",", ".");
  const v = parseFloat(s);
  return isNaN(v) ? 0 : v;
};
const asBool = (v) => (v === true || v === 1 || v === "1" || String(v).toLowerCase()==="true");
const fmt = (x) => (isFinite(x) ? x.toFixed(2) : "0.00");

function downloadText(text, filename, mime="application/json;charset=utf-8") {
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function seedData(){
  return {
    drivers: [
      {driver_id:"DRV-001", full_name:"Örnek TLN", profile_type:"EMPLOYEE_TLN", contract_id:"CTR-TLN-001", is_active:true},
      {driver_id:"DRV-010", full_name:"Örnek ZZP", profile_type:"ZZP_HOURLY", contract_id:"CTR-ZZP-010", is_active:true}
    ],
    contracts: [
      {
        contract_id:"CTR-TLN-001",
        profile_type:"EMPLOYEE_TLN",
        hour_rate_eur:28,
        km_rate_eur:0,
        night_premium_pct:19,
        adr_per_km_eur:0.25,
        tln_overtime_threshold_hours:40,
        tln_overtime_pct:30,
        tln_sat_pct:50,
        tln_sun_pct:100,
        note:"TLN sözleşme örneği"
      },
      {
        contract_id:"CTR-ZZP-010",
        profile_type:"ZZP_HOURLY",
        hour_rate_eur:45,
        km_rate_eur:0,
        night_premium_pct:19,
        adr_per_km_eur:0.25,
        tln_overtime_threshold_hours:40,
        tln_overtime_pct:30,
        tln_sat_pct:50,
        tln_sun_pct:100,
        note:"ZZP saatlik örnek"
      }
    ],
    tours: [
      {
        tour_id: "TUR-0001",
        start_address: "1438AN Oude Meer, Hollanda",
        via_stops: "Stop 1: Amsterdam\nStop 2: Utrecht",
        end_address: "Rotterdam, Hollanda",
        customer: "CUST-01",
        start_dt: "2026-01-05T08:00",
        end_dt: "2026-01-05T18:00",
        tour_price_eur: 650,
        vehicle_type: "Tautliner",
      },
      {
        tour_id: "TUR-0002",
        start_address: "Rotterdam",
        via_stops: "",
        end_address: "Antwerp",
        customer: "CUST-01",
        start_dt: "2026-01-05T19:30",
        end_dt: "2026-01-05T23:30",
        tour_price_eur: 300,
        vehicle_type: "Box",
      }
    ],
    routes: [
      {
        route_no: "NED001",
        driver_mode: "TLN",
        driver_id: "DRV-001",
        sales_price_eur: 1400,
        tour_ids: ["TUR-0001","TUR-0002"],
        note: "Örnek rota"
      }
    ]
  };
}

let state = null;
function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw){
    state = seedData();
    saveState();
    return;
  }
  try{
    state = JSON.parse(raw);
    if (!state.drivers) state.drivers = [];
    if (!state.contracts) state.contracts = [];
    if (!state.tours) state.tours = [];
    if (!state.routes) state.routes = [];
  } catch(e){
    state = seedData();
    saveState();
  }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

/* =========================
   Modal
   ========================= */
function openModal(title, html){
  const back = document.getElementById("modalBack");
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalBody").innerHTML = html;
  back.style.display = "flex";
}
function closeModal(){
  document.getElementById("modalBack").style.display = "none";
}
document.getElementById("modalClose").addEventListener("click", closeModal);
document.getElementById("modalBack").addEventListener("click", (e) => {
  if (e.target?.id === "modalBack") closeModal();
});

/* =========================
   Time calculations (Tour start/end)
   - Night window: 21:00–04:00
   - Weekend: Saturday/Sunday based on time slices
   ========================= */
function nextMidnight(d){
  const x = new Date(d);
  x.setHours(24,0,0,0);
  return x;
}
function sameDayMidnight(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  return x;
}
function overlapMinutes(aStart, aEnd, bStart, bEnd){
  const s = Math.max(aStart.getTime(), bStart.getTime());
  const e = Math.min(aEnd.getTime(), bEnd.getTime());
  const diff = e - s;
  return diff > 0 ? diff/60000 : 0;
}
function computeTimeMetrics(startStr, endStr){
  if (!startStr || !endStr) return null;
  const start = new Date(startStr);
  const end = new Date(endStr);
  if (isNaN(start) || isNaN(end) || end <= start) return null;

  let totalMin = (end - start)/60000;
  let nightMin = 0;
  let satMin = 0;
  let sunMin = 0;

  let cursor = new Date(start);
  while (cursor < end){
    const segEnd = new Date(Math.min(nextMidnight(cursor).getTime(), end.getTime()));
    const dayMid = sameDayMidnight(cursor);

    const dow = cursor.getDay(); // 0 Sun ... 6 Sat
    const segMinutes = (segEnd - cursor)/60000;
    if (dow === 6) satMin += segMinutes;
    if (dow === 0) sunMin += segMinutes;

    // 00:00–04:00
    const w1s = new Date(dayMid); w1s.setHours(0,0,0,0);
    const w1e = new Date(dayMid); w1e.setHours(4,0,0,0);
    nightMin += overlapMinutes(cursor, segEnd, w1s, w1e);

    // 21:00–24:00
    const w2s = new Date(dayMid); w2s.setHours(21,0,0,0);
    const w2e = new Date(dayMid); w2e.setHours(24,0,0,0);
    nightMin += overlapMinutes(cursor, segEnd, w2s, w2e);

    cursor = segEnd;
  }

  return {
    total_hours: totalMin/60,
    night_hours: nightMin/60,
    sat_hours: satMin/60,
    sun_hours: sunMin/60
  };
}

/* =========================
   Helpers / CRUD
   ========================= */
function ptLabel(code){
  return PROFILE_TYPES.find(x=>x.code===code)?.label || code || "";
}
function routeModeLabel(code){
  return ROUTE_DRIVER_MODE.find(x=>x.code===code)?.label || code || "";
}
function getContract(contract_id){
  return state.contracts.find(c => String(c.contract_id) === String(contract_id)) || null;
}
function getDriver(driver_id){
  return state.drivers.find(d => String(d.driver_id) === String(driver_id)) || null;
}
function getTour(tour_id){
  return state.tours.find(t => String(t.tour_id) === String(tour_id)) || null;
}

function upsertDriver(rec){
  const idx = state.drivers.findIndex(x => String(x.driver_id) === String(rec.driver_id));
  if (idx >= 0) state.drivers[idx] = rec;
  else state.drivers.push(rec);
  saveState();
}
function removeDriver(driver_id){
  state.drivers = state.drivers.filter(x => String(x.driver_id) !== String(driver_id));
  // routes: sürücü silinirse route driver_id boşalt
  state.routes = state.routes.map(r => (String(r.driver_id)===String(driver_id)) ? ({...r, driver_id:""}) : r);
  saveState();
}
function upsertContract(rec){
  const idx = state.contracts.findIndex(x => String(x.contract_id) === String(rec.contract_id));
  if (idx >= 0) state.contracts[idx] = rec;
  else state.contracts.push(rec);
  saveState();
}
function removeContract(contract_id){
  const usedBy = state.drivers.filter(d => String(d.contract_id) === String(contract_id)).map(d=>d.driver_id);
  if (usedBy.length){
    const ok = confirm(`Bu sözleşme şu sürücülerde kullanılıyor: ${usedBy.join(", ")}\nYine de silinsin mi?`);
    if (!ok) return;
  }
  state.contracts = state.contracts.filter(x => String(x.contract_id) !== String(contract_id));
  state.drivers = state.drivers.map(d => (String(d.contract_id) === String(contract_id)) ? ({...d, contract_id:""}) : d);
  saveState();
}

function upsertTour(rec){
  const idx = state.tours.findIndex(x => String(x.tour_id) === String(rec.tour_id));
  if (idx >= 0) state.tours[idx] = rec;
  else state.tours.push(rec);
  saveState();
}
function removeTour(tour_id){
  // routes içindeki tour_ids listesinden çıkar
  state.routes = state.routes.map(r => ({...r, tour_ids: (r.tour_ids||[]).filter(id => String(id)!==String(tour_id))}));
  state.tours = state.tours.filter(x => String(x.tour_id) !== String(tour_id));
  saveState();
}

function upsertRoute(rec){
  const idx = state.routes.findIndex(x => String(x.route_no) === String(rec.route_no));
  if (idx >= 0) state.routes[idx] = rec;
  else state.routes.push(rec);
  saveState();
}
function removeRoute(route_no){
  state.routes = state.routes.filter(x => String(x.route_no) !== String(route_no));
  saveState();
}

function buildProfileTypeOptions(selected){
  return PROFILE_TYPES.map(p => {
    const sel = String(selected||"") === p.code ? "selected" : "";
    return `<option value="${esc(p.code)}" ${sel}>${esc(p.label)}</option>`;
  }).join("");
}
function buildContractOptions(selected, profileType){
  const list = state.contracts
    .filter(c => !profileType || String(c.profile_type) === String(profileType))
    .slice()
    .sort((a,b)=>String(a.contract_id).localeCompare(String(b.contract_id)));
  const opts = [`<option value="">— boş —</option>`];
  for (const c of list){
    const sel = String(selected||"") === String(c.contract_id) ? "selected" : "";
    opts.push(`<option value="${esc(c.contract_id)}" ${sel}>${esc(c.contract_id)} (${esc(ptLabel(c.profile_type))})</option>`);
  }
  return opts.join("");
}

function buildDriverOptionsByMode(selected, mode){
  let wantedProfile = "";
  if (mode === "TLN") wantedProfile = "EMPLOYEE_TLN";
  if (mode === "ZZP") wantedProfile = "ZZP_HOURLY";
  if (mode === "CHARTER") wantedProfile = ""; // opsiyonel: charter sürücüler/firmalar sonra eklenir

  const drivers = state.drivers
    .filter(d => asBool(d.is_active))
    .filter(d => !wantedProfile || String(d.profile_type)===wantedProfile)
    .slice()
    .sort((a,b)=>String(a.driver_id).localeCompare(String(b.driver_id)));

  const opts = [`<option value="">— seçin —</option>`];
  for (const d of drivers){
    const sel = String(selected||"") === String(d.driver_id) ? "selected" : "";
    opts.push(`<option value="${esc(d.driver_id)}" ${sel}>${esc(d.driver_id)} | ${esc(d.full_name)}</option>`);
  }
  return opts.join("");
}

/* =========================
   Route P&L calculation
   ========================= */
function calcRouteNumbers(route){
  const tourIds = route.tour_ids || [];
  let purchase = 0;
  let totalH = 0;
  let nightH = 0;
  let satH = 0;
  let sunH = 0;

  for (const id of tourIds){
    const t = getTour(id);
    if (!t) continue;
    purchase += num(t.tour_price_eur);

    const m = computeTimeMetrics(t.start_dt, t.end_dt);
    if (m){
      totalH += m.total_hours;
      nightH += m.night_hours;
      satH += m.sat_hours;
      sunH += m.sun_hours;
    }
  }

  let driverCost = 0;
  const mode = String(route.driver_mode || "CHARTER");

  if (mode === "TLN" || mode === "ZZP"){
    const d = route.driver_id ? getDriver(route.driver_id) : null;
    const c = d?.contract_id ? getContract(d.contract_id) : null;

    const hourRate = num(c?.hour_rate_eur);
    const nightPct = num(c?.night_premium_pct);
    const satPct = num(c?.tln_sat_pct);
    const sunPct = num(c?.tln_sun_pct);

    if (hourRate > 0){
      driverCost += hourRate * totalH;
      if (nightPct > 0) driverCost += hourRate * nightH * (nightPct/100);

      // TLN için hafta sonu primi (ZZP için isterseniz kapatabiliriz)
      if (mode === "TLN"){
        if (satPct > 0) driverCost += hourRate * satH * (satPct/100);
        if (sunPct > 0) driverCost += hourRate * sunH * (sunPct/100);
      }
    }
  } else {
    // CHARTER: varsayılan driverCost = 0 (çünkü alış zaten tour_price içinde)
    driverCost = 0;
  }

  const sales = num(route.sales_price_eur);
  const totalCost = purchase + driverCost;
  const profit = sales - totalCost;

  return {
    purchase_eur: purchase,
    total_hours: totalH,
    night_hours: nightH,
    sat_hours: satH,
    sun_hours: sunH,
    driver_cost_eur: driverCost,
    total_cost_eur: totalCost,
    profit_eur: profit
  };
}

/* =========================
   Tabs / Render
   ========================= */
const TABS = [
  {id:"drivers", label:"Sürücüler"},
  {id:"contracts", label:"Sözleşmeler"},
  {id:"tours", label:"Turlar"},
  {id:"routes", label:"Rotalar"}
];
let activeTab = "routes"; // rota akışını test etmek için default

function renderTabs(){
  const el = document.getElementById("tabs");
  el.innerHTML = "";
  for (const t of TABS){
    const b = document.createElement("button");
    b.textContent = t.label;
    b.className = (activeTab === t.id) ? "active" : "";
    b.addEventListener("click", () => { activeTab = t.id; render(); });
    el.appendChild(b);
  }
}

function render(){
  renderTabs();
  const view = document.getElementById("view");
  view.innerHTML = "";
  if (activeTab === "drivers") view.appendChild(renderDrivers());
  if (activeTab === "contracts") view.appendChild(renderContracts());
  if (activeTab === "tours") view.appendChild(renderTours());
  if (activeTab === "routes") view.appendChild(renderRoutes());
}

/* =========================
   Drivers UI
   ========================= */
function renderDrivers(){
  const card = document.createElement("div");
  card.className = "card";

  const rows = state.drivers.slice().sort((a,b)=>String(a.driver_id).localeCompare(String(b.driver_id)));

  card.innerHTML = `
    <div class="row">
      <h3 style="margin:0;">Sürücüler</h3>
      <div style="flex:1"></div>
      <button class="primary" id="btnAddDriver">Yeni Sürücü</button>
    </div>
    <div class="small" style="margin-top:6px;">
      Alanlar: Sürücü ID, Ad Soyad, Profil Tipi, Sözleşme ID, Aktif/Pasif + Görüntüle/Düzenle/Sil
    </div>
    <div id="driverFormSlot"></div>

    <div class="scroller" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Sürücü ID</th><th>Ad Soyad</th><th>Profil Tipi</th><th>Sözleşme ID</th><th>Durum</th><th>İşlem</th>
          </tr>
        </thead>
        <tbody id="driverTbody"></tbody>
      </table>
    </div>
  `;

  const tbody = card.querySelector("#driverTbody");
  const slot = card.querySelector("#driverFormSlot");

  function renderTable(){
    tbody.innerHTML = "";
    for (const d of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="kbd">${esc(d.driver_id)}</td>
        <td>${esc(d.full_name)}</td>
        <td>${esc(ptLabel(d.profile_type))}</td>
        <td class="kbd">${esc(d.contract_id || "")}</td>
        <td>${asBool(d.is_active) ? `<span class="pill">Aktif</span>` : `<span class="pill">Pasif</span>`}</td>
        <td>
          <button data-view="${esc(d.driver_id)}">Görüntüle</button>
          <button data-edit="${esc(d.driver_id)}">Düzenle</button>
          <button class="danger" data-del="${esc(d.driver_id)}">Sil</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function openDriverForm(existing){
    const d = existing ? {...existing} : {driver_id:"", full_name:"", profile_type:"EMPLOYEE_TLN", contract_id:"", is_active:true};
    slot.innerHTML = `
      <hr/>
      <h4 style="margin:0 0 10px;">${existing ? "Sürücü Düzenle" : "Yeni Sürücü"}</h4>
      <div class="row">
        <label>Sürücü ID *<br/><input id="d_id" type="text" value="${esc(d.driver_id)}" ${existing ? "disabled" : ""}></label>
        <label>Ad Soyad *<br/><input id="d_name" type="text" value="${esc(d.full_name)}"></label>
        <label>Profil Tipi *<br/>
          <select id="d_pt">${buildProfileTypeOptions(d.profile_type)}</select>
        </label>
        <label>Sözleşme ID<br/>
          <select id="d_contract"></select>
        </label>
        <label>Aktif / Pasif<br/>
          <select id="d_active">
            <option value="true" ${asBool(d.is_active)?"selected":""}>Aktif</option>
            <option value="false" ${!asBool(d.is_active)?"selected":""}>Pasif</option>
          </select>
        </label>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="primary" id="d_save">Kaydet</button>
        <button id="d_cancel">Vazgeç</button>
      </div>
    `;

    const ptSel = slot.querySelector("#d_pt");
    const contractSel = slot.querySelector("#d_contract");

    function refreshContracts(){
      contractSel.innerHTML = buildContractOptions(d.contract_id, ptSel.value);
      const exists = Array.from(contractSel.options).some(o => o.value === String(d.contract_id||""));
      if (!exists) contractSel.value = "";
    }
    refreshContracts();
    ptSel.addEventListener("change", refreshContracts);

    slot.querySelector("#d_save").addEventListener("click", () => {
      const driver_id = slot.querySelector("#d_id").value.trim();
      const full_name = slot.querySelector("#d_name").value.trim();
      const profile_type = slot.querySelector("#d_pt").value;
      const contract_id = slot.querySelector("#d_contract").value;
      const is_active = slot.querySelector("#d_active").value === "true";

      if (!driver_id) return alert("Sürücü ID zorunludur.");
      if (!full_name) return alert("Ad Soyad zorunludur.");
      if (!profile_type) return alert("Profil Tipi zorunludur.");

      if (!existing){
        const dup = state.drivers.some(x => String(x.driver_id) === String(driver_id));
        if (dup) return alert("Bu Sürücü ID zaten var: " + driver_id);
      }

      upsertDriver({driver_id, full_name, profile_type, contract_id, is_active});
      slot.innerHTML = "";
      render();
    });

    slot.querySelector("#d_cancel").addEventListener("click", () => slot.innerHTML = "");
  }

  card.querySelector("#btnAddDriver").addEventListener("click", () => openDriverForm(null));

  card.addEventListener("click", (e) => {
    const viewId = e.target?.getAttribute?.("data-view");
    const editId = e.target?.getAttribute?.("data-edit");
    const delId = e.target?.getAttribute?.("data-del");

    if (viewId){
      const d = state.drivers.find(x => String(x.driver_id) === String(viewId));
      if (!d) return;
      const c = d.contract_id ? getContract(d.contract_id) : null;
      openModal("Sürücü Görüntüle", `
        <table>
          <tr><th>Sürücü ID</th><td class="kbd">${esc(d.driver_id)}</td></tr>
          <tr><th>Ad Soyad</th><td>${esc(d.full_name)}</td></tr>
          <tr><th>Profil Tipi</th><td>${esc(ptLabel(d.profile_type))}</td></tr>
          <tr><th>Sözleşme ID</th><td class="kbd">${esc(d.contract_id||"")}</td></tr>
          <tr><th>Sözleşme Profil Tipi</th><td>${esc(c ? ptLabel(c.profile_type) : "")}</td></tr>
          <tr><th>Durum</th><td>${asBool(d.is_active) ? "Aktif" : "Pasif"}</td></tr>
        </table>
      `);
    }

    if (editId){
      const d = state.drivers.find(x => String(x.driver_id) === String(editId));
      if (!d) return;
      openDriverForm(d);
    }

    if (delId){
      if (!confirm("Sürücü silinsin mi?")) return;
      removeDriver(delId);
      render();
    }
  });

  renderTable();
  return card;
}

/* =========================
   Contracts UI
   ========================= */
function renderContracts(){
  const card = document.createElement("div");
  card.className = "card";

  const rows = state.contracts.slice().sort((a,b)=>String(a.contract_id).localeCompare(String(b.contract_id)));

  card.innerHTML = `
    <div class="row">
      <h3 style="margin:0;">Sözleşmeler</h3>
      <div style="flex:1"></div>
      <button class="primary" id="btnAddContract">Yeni Sözleşme</button>
    </div>
    <div class="small" style="margin-top:6px;">
      Alanlar: Sözleşme ID, Profil Tipi, Saat/KM ücreti, Gece primi, ADR, TLN haftalık overtime + Cumartesi/Pazar + Not
    </div>

    <div id="contractFormSlot"></div>

    <div class="scroller" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Sözleşme ID</th><th>Profil Tipi</th>
            <th class="right">Saat €</th><th class="right">KM €</th>
            <th class="right">Gece %</th><th class="right">ADR €/km</th>
            <th class="right">OT Eşik</th><th class="right">OT %</th>
            <th class="right">Cts %</th><th class="right">Paz %</th>
            <th>Not</th><th>İşlem</th>
          </tr>
        </thead>
        <tbody id="contractTbody"></tbody>
      </table>
    </div>
  `;

  const tbody = card.querySelector("#contractTbody");
  const slot = card.querySelector("#contractFormSlot");

  function renderTable(){
    tbody.innerHTML = "";
    for (const c of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="kbd">${esc(c.contract_id)}</td>
        <td>${esc(ptLabel(c.profile_type))}</td>
        <td class="right">€${fmt(num(c.hour_rate_eur))}</td>
        <td class="right">€${fmt(num(c.km_rate_eur))}</td>
        <td class="right">${fmt(num(c.night_premium_pct))}</td>
        <td class="right">€${fmt(num(c.adr_per_km_eur))}</td>
        <td class="right">${fmt(num(c.tln_overtime_threshold_hours))}</td>
        <td class="right">${fmt(num(c.tln_overtime_pct))}</td>
        <td class="right">${fmt(num(c.tln_sat_pct))}</td>
        <td class="right">${fmt(num(c.tln_sun_pct))}</td>
        <td>${esc(c.note||"")}</td>
        <td>
          <button data-view="${esc(c.contract_id)}">Görüntüle</button>
          <button data-edit="${esc(c.contract_id)}">Düzenle</button>
          <button class="danger" data-del="${esc(c.contract_id)}">Sil</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function openContractForm(existing){
    const c = existing ? {...existing} : {
      contract_id:"",
      profile_type:"EMPLOYEE_TLN",
      hour_rate_eur:0,
      km_rate_eur:0,
      night_premium_pct:19,
      adr_per_km_eur:0.25,
      tln_overtime_threshold_hours:40,
      tln_overtime_pct:30,
      tln_sat_pct:50,
      tln_sun_pct:100,
      note:""
    };

    slot.innerHTML = `
      <hr/>
      <h4 style="margin:0 0 10px;">${existing ? "Sözleşme Düzenle" : "Yeni Sözleşme"}</h4>
      <div class="row">
        <label>Sözleşme ID *<br/><input id="c_id" type="text" value="${esc(c.contract_id)}" ${existing ? "disabled" : ""}></label>
        <label>Profil Tipi *<br/>
          <select id="c_pt">${buildProfileTypeOptions(c.profile_type)}</select>
        </label>
        <label>Saat Ücreti (€)<br/><input id="c_hr" type="number" step="0.01" value="${esc(c.hour_rate_eur)}"></label>
        <label>KM Ücreti (€)<br/><input id="c_km" type="number" step="0.01" value="${esc(c.km_rate_eur)}"></label>
        <label>Gece Primi % (21:00–04:00)<br/><input id="c_night" type="number" step="0.01" value="${esc(c.night_premium_pct)}"></label>
        <label>ADR €/km<br/><input id="c_adr" type="number" step="0.01" value="${esc(c.adr_per_km_eur)}"></label>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>TLN Overtime Eşiği (haftalık)<br/><input id="c_ot_thr" type="number" step="0.01" value="${esc(c.tln_overtime_threshold_hours)}"></label>
        <label>TLN Overtime %<br/><input id="c_ot_pct" type="number" step="0.01" value="${esc(c.tln_overtime_pct)}"></label>
        <label>TLN Cumartesi %<br/><input id="c_sat" type="number" step="0.01" value="${esc(c.tln_sat_pct)}"></label>
        <label>TLN Pazar %<br/><input id="c_sun" type="number" step="0.01" value="${esc(c.tln_sun_pct)}"></label>
      </div>

      <div style="margin-top:10px;">
        <label>Not<br/><textarea id="c_note">${esc(c.note||"")}</textarea></label>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="primary" id="c_save">Kaydet</button>
        <button id="c_cancel">Vazgeç</button>
      </div>
    `;

    slot.querySelector("#c_save").addEventListener("click", () => {
      const contract_id = slot.querySelector("#c_id").value.trim();
      const profile_type = slot.querySelector("#c_pt").value;

      if (!contract_id) return alert("Sözleşme ID zorunludur.");
      if (!profile_type) return alert("Profil Tipi zorunludur.");

      if (!existing){
        const dup = state.contracts.some(x => String(x.contract_id) === String(contract_id));
        if (dup) return alert("Bu Sözleşme ID zaten var: " + contract_id);
      }

      const rec = {
        contract_id,
        profile_type,
        hour_rate_eur: num(slot.querySelector("#c_hr").value),
        km_rate_eur: num(slot.querySelector("#c_km").value),
        night_premium_pct: num(slot.querySelector("#c_night").value),
        adr_per_km_eur: num(slot.querySelector("#c_adr").value),
        tln_overtime_threshold_hours: num(slot.querySelector("#c_ot_thr").value),
        tln_overtime_pct: num(slot.querySelector("#c_ot_pct").value),
        tln_sat_pct: num(slot.querySelector("#c_sat").value),
        tln_sun_pct: num(slot.querySelector("#c_sun").value),
        note: slot.querySelector("#c_note").value.trim()
      };

      upsertContract(rec);
      slot.innerHTML = "";
      render();
    });

    slot.querySelector("#c_cancel").addEventListener("click", () => slot.innerHTML = "");
  }

  card.querySelector("#btnAddContract").addEventListener("click", () => openContractForm(null));

  card.addEventListener("click", (e) => {
    const viewId = e.target?.getAttribute?.("data-view");
    const editId = e.target?.getAttribute?.("data-edit");
    const delId = e.target?.getAttribute?.("data-del");

    if (viewId){
      const c = state.contracts.find(x => String(x.contract_id) === String(viewId));
      if (!c) return;
      openModal("Sözleşme Görüntüle", `
        <table>
          <tr><th>Sözleşme ID</th><td class="kbd">${esc(c.contract_id)}</td></tr>
          <tr><th>Profil Tipi</th><td>${esc(ptLabel(c.profile_type))}</td></tr>
          <tr><th>Saat Ücreti (€)</th><td>€${fmt(num(c.hour_rate_eur))}</td></tr>
          <tr><th>KM Ücreti (€)</th><td>€${fmt(num(c.km_rate_eur))}</td></tr>
          <tr><th>Gece Primi %</th><td>${fmt(num(c.night_premium_pct))}</td></tr>
          <tr><th>ADR €/km</th><td>€${fmt(num(c.adr_per_km_eur))}</td></tr>
          <tr><th>TLN Overtime Eşiği (haftalık)</th><td>${fmt(num(c.tln_overtime_threshold_hours))}</td></tr>
          <tr><th>TLN Overtime %</th><td>${fmt(num(c.tln_overtime_pct))}</td></tr>
          <tr><th>TLN Cumartesi %</th><td>${fmt(num(c.tln_sat_pct))}</td></tr>
          <tr><th>TLN Pazar %</th><td>${fmt(num(c.tln_sun_pct))}</td></tr>
          <tr><th>Not</th><td>${esc(c.note||"")}</td></tr>
        </table>
      `);
    }

    if (editId){
      const c = state.contracts.find(x => String(x.contract_id) === String(editId));
      if (!c) return;
      openContractForm(c);
    }

    if (delId){
      if (!confirm("Sözleşme silinsin mi?")) return;
      removeContract(delId);
      render();
    }
  });

  renderTable();
  return card;
}

/* =========================
   Tours UI
   ========================= */
function renderTours(){
  const card = document.createElement("div");
  card.className = "card";
  const rows = state.tours.slice().sort((a,b)=>String(a.tour_id).localeCompare(String(b.tour_id)));

  card.innerHTML = `
    <div class="row">
      <h3 style="margin:0;">Turlar</h3>
      <div style="flex:1"></div>
      <button class="primary" id="btnAddTour">Yeni Tur</button>
    </div>
    <div class="small" style="margin-top:6px;">
      Tur fiyatı bu sistemde “alış fiyatı” olarak kullanılır (rotaya eklenince alış toplamına dahil olur).
    </div>

    <div id="tourFormSlot"></div>

    <div class="scroller" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>TURID</th><th>Müşteri</th><th>Başlangıç</th><th>Ara Duraklar</th><th>Bitiş</th>
            <th>Başlangıç</th><th>Bitiş</th><th class="right">Alış (€)</th><th>Araç Tipi</th><th>İşlem</th>
          </tr>
        </thead>
        <tbody id="tourTbody"></tbody>
      </table>
    </div>
  `;

  const tbody = card.querySelector("#tourTbody");
  const slot = card.querySelector("#tourFormSlot");

  function renderTable(){
    tbody.innerHTML = "";
    for (const t of rows){
      const viaShort = String(t.via_stops||"").trim();
      const viaDisplay = viaShort ? (viaShort.split("\n").slice(0,2).join(" | ") + (viaShort.split("\n").length>2 ? " ..." : "")) : "";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="kbd">${esc(t.tour_id)}</td>
        <td>${esc(t.customer || "")}</td>
        <td>${esc(t.start_address || "")}</td>
        <td>${esc(viaDisplay)}</td>
        <td>${esc(t.end_address || "")}</td>
        <td class="kbd">${esc(t.start_dt || "")}</td>
        <td class="kbd">${esc(t.end_dt || "")}</td>
        <td class="right">€${fmt(num(t.tour_price_eur))}</td>
        <td>${esc(t.vehicle_type || "")}</td>
        <td>
          <button data-view="${esc(t.tour_id)}">Görüntüle</button>
          <button data-edit="${esc(t.tour_id)}">Düzenle</button>
          <button class="danger" data-del="${esc(t.tour_id)}">Sil</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function openTourForm(existing){
    const t = existing ? {...existing} : {
      tour_id: "",
      start_address: "",
      via_stops: "",
      end_address: "",
      customer: "",
      start_dt: "",
      end_dt: "",
      tour_price_eur: 0,
      vehicle_type: ""
    };

    slot.innerHTML = `
      <hr/>
      <h4 style="margin:0 0 10px;">${existing ? "Tur Düzenle" : "Yeni Tur"}</h4>

      <div class="row">
        <label>TURID *<br/><input id="t_id" type="text" value="${esc(t.tour_id)}" ${existing ? "disabled" : ""}></label>
        <label>Müşteri (Customer)<br/><input id="t_customer" type="text" value="${esc(t.customer||"")}"></label>
        <label>Araç Tipi<br/><input id="t_vehicle" type="text" value="${esc(t.vehicle_type||"")}"></label>
        <label>Tur Alış Fiyatı (€)<br/><input id="t_price" type="number" step="0.01" value="${esc(t.tour_price_eur)}"></label>
      </div>

      <div class="row" style="margin-top:10px;">
        <label style="flex:1; min-width:280px;">Tur Başlangıç Adresi<br/><input id="t_start_addr" type="text" value="${esc(t.start_address||"")}" style="width:100%;"></label>
        <label style="flex:1; min-width:280px;">Tur Bitiş Adresi<br/><input id="t_end_addr" type="text" value="${esc(t.end_address||"")}" style="width:100%;"></label>
      </div>

      <div style="margin-top:10px;">
        <label>Ara Duraklar (her satır 1 durak)<br/>
          <textarea id="t_via">${esc(t.via_stops||"")}</textarea>
        </label>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>Tur Başlangıç Saati<br/><input id="t_start_dt" type="datetime-local" value="${esc(t.start_dt||"")}"></label>
        <label>Tur Bitiş Saati<br/><input id="t_end_dt" type="datetime-local" value="${esc(t.end_dt||"")}"></label>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="primary" id="t_save">Kaydet</button>
        <button id="t_cancel">Vazgeç</button>
      </div>
    `;

    slot.querySelector("#t_save").addEventListener("click", () => {
      const tour_id = slot.querySelector("#t_id").value.trim();
      if (!tour_id) return alert("TURID zorunludur.");

      if (!existing){
        const dup = state.tours.some(x => String(x.tour_id) === String(tour_id));
        if (dup) return alert("Bu TURID zaten var: " + tour_id);
      }

      const start_dt = slot.querySelector("#t_start_dt").value;
      const end_dt = slot.querySelector("#t_end_dt").value;
      if (start_dt && end_dt){
        const a = new Date(start_dt);
        const b = new Date(end_dt);
        if (!isNaN(a) && !isNaN(b) && b < a){
          return alert("Tur Bitiş Saati, Başlangıç Saatinden küçük olamaz.");
        }
      }

      const rec = {
        tour_id,
        start_address: slot.querySelector("#t_start_addr").value.trim(),
        via_stops: slot.querySelector("#t_via").value.trim(),
        end_address: slot.querySelector("#t_end_addr").value.trim(),
        customer: slot.querySelector("#t_customer").value.trim(),
        start_dt,
        end_dt,
        tour_price_eur: num(slot.querySelector("#t_price").value),
        vehicle_type: slot.querySelector("#t_vehicle").value.trim()
      };

      upsertTour(rec);
      slot.innerHTML = "";
      render();
    });

    slot.querySelector("#t_cancel").addEventListener("click", () => slot.innerHTML = "");
  }

  card.querySelector("#btnAddTour").addEventListener("click", () => openTourForm(null));

  card.addEventListener("click", (e) => {
    const viewId = e.target?.getAttribute?.("data-view");
    const editId = e.target?.getAttribute?.("data-edit");
    const delId = e.target?.getAttribute?.("data-del");

    if (viewId){
      const t = state.tours.find(x => String(x.tour_id) === String(viewId));
      if (!t) return;

      const vias = String(t.via_stops||"").trim()
        ? `<ul>${String(t.via_stops).split("\n").map(x=>x.trim()).filter(Boolean).map(x=>`<li>${esc(x)}</li>`).join("")}</ul>`
        : `<span class="muted">Yok</span>`;

      openModal("Tur Görüntüle", `
        <table>
          <tr><th>TURID</th><td class="kbd">${esc(t.tour_id)}</td></tr>
          <tr><th>Müşteri</th><td>${esc(t.customer||"")}</td></tr>
          <tr><th>Başlangıç</th><td>${esc(t.start_address||"")}</td></tr>
          <tr><th>Ara Duraklar</th><td>${vias}</td></tr>
          <tr><th>Bitiş</th><td>${esc(t.end_address||"")}</td></tr>
          <tr><th>Başlangıç</th><td class="kbd">${esc(t.start_dt||"")}</td></tr>
          <tr><th>Bitiş</th><td class="kbd">${esc(t.end_dt||"")}</td></tr>
          <tr><th>Alış (€)</th><td>€${fmt(num(t.tour_price_eur))}</td></tr>
          <tr><th>Araç Tipi</th><td>${esc(t.vehicle_type||"")}</td></tr>
        </table>
      `);
    }

    if (editId){
      const t = state.tours.find(x => String(x.tour_id) === String(editId));
      if (!t) return;
      openTourForm(t);
    }

    if (delId){
      if (!confirm("Tur silinsin mi? (Rotalardan da çıkarılır)")) return;
      removeTour(delId);
      render();
    }
  });

  renderTable();
  return card;
}

/* =========================
   Routes UI
   ========================= */
function renderRoutes(){
  const card = document.createElement("div");
  card.className = "card";
  const rows = state.routes.slice().sort((a,b)=>String(a.route_no).localeCompare(String(b.route_no)));

  card.innerHTML = `
    <div class="row">
      <h3 style="margin:0;">Rotalar</h3>
      <div style="flex:1"></div>
      <button class="primary" id="btnAddRoute">Yeni Rota (NED001)</button>
    </div>

    <div class="hint small" style="margin-top:10px;">
      <b>Kural:</b> Rota, turlardan seçilerek oluşturulur. Tur fiyatları “alış” olarak toplanır. <br/>
      TLN/ZZP sürücü atanırsa sözleşme saat ücretinden maliyet hesaplanır (gece + TLN hafta sonu primi).
      <br/><b>Not:</b> TLN haftalık overtime (40+ %30) için “haftalık plan” modülü geldiğinde eklenecek.
    </div>

    <div id="routeFormSlot"></div>

    <div class="scroller" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Rota No</th>
            <th>Sürücü Tipi</th>
            <th>Sürücü</th>
            <th class="right">Tur Adet</th>
            <th class="right">Alış Toplam (€)</th>
            <th class="right">Sürücü Maliyeti (€)</th>
            <th class="right">Toplam Maliyet (€)</th>
            <th class="right">Satış (€)</th>
            <th class="right">Kâr (€)</th>
            <th>İşlem</th>
          </tr>
        </thead>
        <tbody id="routeTbody"></tbody>
      </table>
    </div>
  `;

  const tbody = card.querySelector("#routeTbody");
  const slot = card.querySelector("#routeFormSlot");

  function renderTable(){
    tbody.innerHTML = "";
    for (const r of rows){
      const d = r.driver_id ? getDriver(r.driver_id) : null;
      const n = calcRouteNumbers(r);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="kbd">${esc(r.route_no)}</td>
        <td>${esc(routeModeLabel(r.driver_mode))}</td>
        <td>${d ? esc(d.driver_id + " | " + d.full_name) : esc(r.driver_id || "")}</td>
        <td class="right">${(r.tour_ids||[]).length}</td>
        <td class="right">€${fmt(n.purchase_eur)}</td>
        <td class="right">€${fmt(n.driver_cost_eur)}</td>
        <td class="right">€${fmt(n.total_cost_eur)}</td>
        <td class="right">€${fmt(num(r.sales_price_eur))}</td>
        <td class="right">€${fmt(n.profit_eur)}</td>
        <td>
          <button data-view="${esc(r.route_no)}">Görüntüle</button>
          <button data-edit="${esc(r.route_no)}">Düzenle</button>
          <button class="danger" data-del="${esc(r.route_no)}">Sil</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function openRouteForm(existing){
    const r = existing ? {...existing} : {
      route_no: "",
      driver_mode: "CHARTER",
      driver_id: "",
      sales_price_eur: 0,
      tour_ids: [],
      note: ""
    };

    const tourRows = state.tours.slice().sort((a,b)=>String(a.tour_id).localeCompare(String(b.tour_id)));

    slot.innerHTML = `
      <hr/>
      <h4 style="margin:0 0 10px;">${existing ? "Rota Düzenle" : "Yeni Rota"}</h4>

      <div class="row">
        <label>Rota No (örn NED001) *<br/><input id="r_no" type="text" value="${esc(r.route_no)}" ${existing ? "disabled" : ""}></label>

        <label>Kim Sürüyor? *<br/>
          <select id="r_mode">
            ${ROUTE_DRIVER_MODE.map(x=>`<option value="${esc(x.code)}" ${x.code===r.driver_mode?"selected":""}>${esc(x.label)}</option>`).join("")}
          </select>
        </label>

        <label>Sürücü Seç (TLN/ZZP ise)<br/>
          <select id="r_driver"></select>
        </label>

        <label>Rota Satış Fiyatı (€)<br/><input id="r_sales" type="number" step="0.01" value="${esc(r.sales_price_eur)}"></label>
      </div>

      <div style="margin-top:10px;">
        <label>Not<br/><textarea id="r_note">${esc(r.note||"")}</textarea></label>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div>
          <h4 style="margin:0 0 8px;">Turlardan Ekle</h4>
          <div class="scroller" style="max-height:280px;">
            <table>
              <thead>
                <tr>
                  <th>Seç</th><th>TURID</th><th>Müşteri</th><th>Başlangıç</th><th>Bitiş</th><th class="right">Alış (€)</th><th>Araç</th>
                </tr>
              </thead>
              <tbody id="r_tourBody"></tbody>
            </table>
          </div>
        </div>

        <div>
          <h4 style="margin:0 0 8px;">Özet</h4>
          <div class="card" style="box-shadow:none;">
            <div class="row">
              <span class="pill">Alış Toplam: <b id="sum_purchase">€0.00</b></span>
              <span class="pill">Toplam Süre: <b id="sum_hours">0.00h</b></span>
            </div>
            <div class="row" style="margin-top:8px;">
              <span class="pill">Gece: <b id="sum_night">0.00h</b></span>
              <span class="pill">Cts: <b id="sum_sat">0.00h</b></span>
              <span class="pill">Paz: <b id="sum_sun">0.00h</b></span>
            </div>
            <hr/>
            <div class="row">
              <span class="pill">Sürücü Maliyeti: <b id="sum_driver">€0.00</b></span>
              <span class="pill">Toplam Maliyet: <b id="sum_total">€0.00</b></span>
            </div>
            <div class="row" style="margin-top:8px;">
              <span class="pill">Satış: <b id="sum_sales">€0.00</b></span>
              <span class="pill">Kâr: <b id="sum_profit">€0.00</b></span>
            </div>

            <div class="small" style="margin-top:10px;">
              TLN/ZZP için sürücü seçilmezse sürücü maliyeti 0 kalır. Charter’da varsayılan sürücü maliyeti 0’dır
              (alış zaten turlardan gelir).
            </div>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="primary" id="r_save">Kaydet</button>
        <button id="r_cancel">Vazgeç</button>
      </div>
    `;

    const modeSel = slot.querySelector("#r_mode");
    const driverSel = slot.querySelector("#r_driver");
    const tourBody = slot.querySelector("#r_tourBody");

    function refreshDriverOptions(){
      driverSel.innerHTML = buildDriverOptionsByMode(r.driver_id, modeSel.value);
      // Charter modunda driver seçimi opsiyonel; TLN/ZZP modunda seçimi teşvik ediyoruz
      driverSel.disabled = (modeSel.value === "CHARTER");
      if (modeSel.value === "CHARTER") driverSel.value = "";
    }

    function renderToursChecklist(){
      tourBody.innerHTML = "";
      for (const t of tourRows){
        const checked = (r.tour_ids||[]).some(id => String(id)===String(t.tour_id)) ? "checked" : "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="right"><input type="checkbox" data-tour="${esc(t.tour_id)}" ${checked}></td>
          <td class="kbd">${esc(t.tour_id)}</td>
          <td>${esc(t.customer||"")}</td>
          <td class="kbd">${esc(t.start_dt||"")}</td>
          <td class="kbd">${esc(t.end_dt||"")}</td>
          <td class="right">€${fmt(num(t.tour_price_eur))}</td>
          <td>${esc(t.vehicle_type||"")}</td>
        `;
        tourBody.appendChild(tr);
      }
    }

    function recomputeSummary(){
      const tmp = {
        ...r,
        driver_mode: modeSel.value,
        driver_id: driverSel.value,
        sales_price_eur: num(slot.querySelector("#r_sales").value)
      };
      const n = calcRouteNumbers(tmp);

      slot.querySelector("#sum_purchase").textContent = "€" + fmt(n.purchase_eur);
      slot.querySelector("#sum_hours").textContent = n.total_hours.toFixed(2) + "h";
      slot.querySelector("#sum_night").textContent = n.night_hours.toFixed(2) + "h";
      slot.querySelector("#sum_sat").textContent = n.sat_hours.toFixed(2) + "h";
      slot.querySelector("#sum_sun").textContent = n.sun_hours.toFixed(2) + "h";
      slot.querySelector("#sum_driver").textContent = "€" + fmt(n.driver_cost_eur);
      slot.querySelector("#sum_total").textContent = "€" + fmt(n.total_cost_eur);
      slot.querySelector("#sum_sales").textContent = "€" + fmt(num(tmp.sales_price_eur));
      slot.querySelector("#sum_profit").textContent = "€" + fmt(n.profit_eur);
    }

    // init
    refreshDriverOptions();
    renderToursChecklist();
    recomputeSummary();

    modeSel.addEventListener("change", () => {
      // mod değişince, sürücü listesi ve seçimi güncelle
      refreshDriverOptions();
      recomputeSummary();
    });

    driverSel.addEventListener("change", () => {
      r.driver_id = driverSel.value;
      recomputeSummary();
    });

    slot.querySelector("#r_sales").addEventListener("input", recomputeSummary);

    tourBody.addEventListener("change", (e) => {
      const tid = e.target?.getAttribute?.("data-tour");
      if (!tid) return;
      const on = e.target.checked;
      const set = new Set(r.tour_ids || []);
      if (on) set.add(tid);
      else set.delete(tid);
      r.tour_ids = Array.from(set);
      recomputeSummary();
    });

    slot.querySelector("#r_save").addEventListener("click", () => {
      const route_no = slot.querySelector("#r_no").value.trim();
      if (!route_no) return alert("Rota No zorunludur (örn NED001).");

      if (!existing){
        const dup = state.routes.some(x => String(x.route_no) === String(route_no));
        if (dup) return alert("Bu Rota No zaten var: " + route_no);
      }

      const driver_mode = modeSel.value;
      const driver_id = driverSel.value;
      const sales_price_eur = num(slot.querySelector("#r_sales").value);

      // TLN/ZZP ise sürücü seçmeyi zorunlu yapalım mı?
      // Şimdilik uyarı veriyoruz; isterseniz zorunlu hale getiririm.
      if ((driver_mode==="TLN" || driver_mode==="ZZP") && !driver_id){
        const ok = confirm("TLN/ZZP seçtiniz ama sürücü seçmediniz. Yine de kaydedilsin mi?");
        if (!ok) return;
      }

      const rec = {
        route_no,
        driver_mode,
        driver_id: (driver_mode==="CHARTER") ? "" : driver_id,
        sales_price_eur,
        tour_ids: r.tour_ids || [],
        note: slot.querySelector("#r_note").value.trim()
      };

      upsertRoute(rec);
      slot.innerHTML = "";
      render();
    });

    slot.querySelector("#r_cancel").addEventListener("click", () => slot.innerHTML = "");
  }

  card.querySelector("#btnAddRoute").addEventListener("click", () => openRouteForm(null));

  card.addEventListener("click", (e) => {
    const viewId = e.target?.getAttribute?.("data-view");
    const editId = e.target?.getAttribute?.("data-edit");
    const delId = e.target?.getAttribute?.("data-del");

    if (viewId){
      const r = state.routes.find(x => String(x.route_no) === String(viewId));
      if (!r) return;

      const d = r.driver_id ? getDriver(r.driver_id) : null;
      const c = d?.contract_id ? getContract(d.contract_id) : null;

      const n = calcRouteNumbers(r);

      const tourLines = (r.tour_ids||[])
        .map(id => getTour(id))
        .filter(Boolean)
        .map(t => `
          <tr>
            <td class="kbd">${esc(t.tour_id)}</td>
            <td>${esc(t.customer||"")}</td>
            <td class="kbd">${esc(t.start_dt||"")}</td>
            <td class="kbd">${esc(t.end_dt||"")}</td>
            <td class="right">€${fmt(num(t.tour_price_eur))}</td>
            <td>${esc(t.vehicle_type||"")}</td>
          </tr>
        `).join("");

      openModal("Rota Görüntüle", `
        <div class="grid2">
          <div>
            <table>
              <tr><th>Rota No</th><td class="kbd">${esc(r.route_no)}</td></tr>
              <tr><th>Sürücü Tipi</th><td>${esc(routeModeLabel(r.driver_mode))}</td></tr>
              <tr><th>Sürücü</th><td>${d ? esc(d.driver_id + " | " + d.full_name) : esc("")}</td></tr>
              <tr><th>Sözleşme</th><td class="kbd">${esc(c?.contract_id || "")}</td></tr>
              <tr><th>Satış (€)</th><td>€${fmt(num(r.sales_price_eur))}</td></tr>
              <tr><th>Alış Toplam (€)</th><td>€${fmt(n.purchase_eur)}</td></tr>
              <tr><th>Sürücü Maliyeti (€)</th><td>€${fmt(n.driver_cost_eur)}</td></tr>
              <tr><th>Toplam Maliyet (€)</th><td>€${fmt(n.total_cost_eur)}</td></tr>
              <tr><th>Kâr (€)</th><td>€${fmt(n.profit_eur)}</td></tr>
              <tr><th>Not</th><td>${esc(r.note||"")}</td></tr>
            </table>
          </div>
          <div>
            <table>
              <tr><th>Toplam Süre</th><td>${n.total_hours.toFixed(2)}h</td></tr>
              <tr><th>Gece</th><td>${n.night_hours.toFixed(2)}h</td></tr>
              <tr><th>Cumartesi</th><td>${n.sat_hours.toFixed(2)}h</td></tr>
              <tr><th>Pazar</th><td>${n.sun_hours.toFixed(2)}h</td></tr>
            </table>
          </div>
        </div>
        <hr/>
        <h4 style="margin:0 0 8px;">Rota İçindeki Turlar</h4>
        <div class="scroller" style="max-height:320px;">
          <table>
            <thead>
              <tr><th>TURID</th><th>Müşteri</th><th>Başlangıç</th><th>Bitiş</th><th class="right">Alış (€)</th><th>Araç</th></tr>
            </thead>
            <tbody>
              ${tourLines || `<tr><td colspan="6" class="muted">Tur yok</td></tr>`}
            </tbody>
          </table>
        </div>
      `);
    }

    if (editId){
      const r = state.routes.find(x => String(x.route_no) === String(editId));
      if (!r) return;
      openRouteForm(r);
    }

    if (delId){
      if (!confirm("Rota silinsin mi?")) return;
      removeRoute(delId);
      render();
    }
  });

  renderTable();
  return card;
}

/* =========================
   Backup / Reset
   ========================= */
document.getElementById("btnExport").addEventListener("click", () => {
  downloadText(JSON.stringify(state, null, 2), "nedline_backup.json");
});

document.getElementById("btnImport").addEventListener("click", () => {
  const input = document.getElementById("fileInput");
  input.value = "";
  input.onchange = async () => {
    const f = input.files[0];
    if (!f) return;
    const txt = await f.text();
    try{
      const obj = JSON.parse(txt);
      if (!obj.drivers || !obj.contracts || !obj.tours) throw new Error("Format geçersiz (drivers/contracts/tours yok).");
      if (!obj.routes) obj.routes = [];
      state = obj;
      saveState();
      alert("Yedek içe aktarıldı.");
      render();
    } catch(e){
      alert("Yedek içe aktarılamadı: " + e.message);
    }
  };
  input.click();
});

document.getElementById("btnReset").addEventListener("click", () => {
  if (!confirm("Tüm veriler silinecek. Emin misiniz?")) return;
  localStorage.removeItem(STORAGE_KEY);
  loadState();
  render();
});

/* =========================
   Init
   ========================= */
loadState();
render();
</script>
</body>
</html>
