<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NedLine - Sürücüler & Sözleşmeler (MVP)</title>
  <style>
    :root { --b:#e6e6e6; --bg:#fafafa; --txt:#111; --muted:#666; --card:#fff; --shadow: 0 6px 18px rgba(0,0,0,.06); }
    body{ font-family: Arial, sans-serif; margin:18px; color:var(--txt); background:#fff; }
    h1{ margin:0 0 6px; font-size:20px; }
    .muted{ color:var(--muted); font-size:12px; line-height:1.4; }
    .topbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:12px 0 14px; }
    .tabbar{ display:flex; gap:8px; flex-wrap:wrap; }
    .tabbar button{
      border:1px solid var(--b); background:var(--bg); padding:10px 12px; border-radius:12px; cursor:pointer;
      font-size:13px;
    }
    .tabbar button.active{ background:#111; color:#fff; border-color:#111; }
    .card{ border:1px solid var(--b); border-radius:14px; padding:14px; margin-top:12px; background:var(--card); box-shadow: var(--shadow); }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; }
    label{ font-size:12px; }
    input, select, textarea{
      border:1px solid var(--b); border-radius:10px; padding:8px 10px; font-size:13px; background:#fff;
    }
    textarea{ min-height:80px; width:100%; }
    button{
      border:1px solid var(--b); background:var(--bg); padding:10px 12px; border-radius:12px; cursor:pointer;
      font-size:13px;
    }
    button.primary{ background:#111; color:#fff; border-color:#111; }
    button.primary:hover{ background:#000; }
    button.danger{ background:#fff3f3; border-color:#ffd0d0; }
    button:hover{ background:#f0f0f0; }
    hr{ border:0; border-top:1px solid #eee; margin:12px 0; }
    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th, td{ border:1px solid #eee; padding:8px; font-size:12px; vertical-align:top; }
    th{ background:#fbfbfb; text-align:left; position:sticky; top:0; z-index:1; }
    .right{ text-align:right; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--b); font-size:12px; background:#fff; }
    .scroller{ overflow:auto; max-height:520px; border:1px solid #eee; border-radius:12px; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px; }
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:14px;
      z-index: 9999;
    }
    .modal{
      background:#fff; border-radius:14px; border:1px solid #eee; padding:14px; width:min(900px, 100%);
      box-shadow: 0 20px 60px rgba(0,0,0,.2);
    }
    .modal h3{ margin:0 0 8px; }
    .small{ font-size:11px; color:var(--muted); }
  </style>
</head>
<body>

<h1>NedLine MVP — Sürücüler & Sözleşmeler</h1>
<div class="muted">
  Bu sürüm: manuel giriş + LocalStorage. Sürücü ve Sözleşme CRUD (Görüntüle/Düzenle/Sil) hazır.
</div>

<div class="topbar">
  <div class="tabbar" id="tabs"></div>
  <div style="flex:1"></div>
  <div class="row">
    <button id="btnExport">Yedek (JSON) Dışa Aktar</button>
    <button id="btnImport">Yedek (JSON) İçe Aktar</button>
    <button class="danger" id="btnReset">Tüm Veriyi Sıfırla</button>
  </div>
</div>

<div id="view"></div>

<input type="file" id="fileInput" style="display:none" accept=".json"/>

<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="row">
      <h3 id="modalTitle" style="margin:0;">Görüntüle</h3>
      <div style="flex:1"></div>
      <button id="modalClose">Kapat</button>
    </div>
    <div id="modalBody" style="margin-top:10px;"></div>
  </div>
</div>

<script>
/* =========================
   Storage / State
   ========================= */
const STORAGE_KEY = "nedline_mvp_v1_drivers_contracts";

const PROFILE_TYPES = [
  {code:"EMPLOYEE_TLN", label:"Employe TLN"},
  {code:"ZZP_HOURLY", label:"ZZP HOURLY"},
  {code:"CHARTER_KM", label:"CHARTER KM"},
  {code:"CHARTER_HOUR", label:"CHARTER HOUR"},
  {code:"CHARTER_FIXED", label:"CHARTER FIXED"}
];

const esc = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const num = (x) => {
  if (x === null || x === undefined) return 0;
  const s = String(x).trim().replace(",", ".");
  const v = parseFloat(s);
  return isNaN(v) ? 0 : v;
};
const asBool = (v) => (v === true || v === 1 || v === "1" || String(v).toLowerCase()==="true");
const fmt = (x) => (isFinite(x) ? x.toFixed(2) : "0.00");

function downloadText(text, filename, mime="application/json;charset=utf-8") {
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function seedData(){
  return {
    drivers: [
      {driver_id:"DRV-001", full_name:"Örnek TLN", profile_type:"EMPLOYEE_TLN", contract_id:"CTR-TLN-001", is_active:true},
      {driver_id:"DRV-010", full_name:"Örnek ZZP", profile_type:"ZZP_HOURLY", contract_id:"CTR-ZZP-010", is_active:true}
    ],
    contracts: [
      {
        contract_id:"CTR-TLN-001",
        profile_type:"EMPLOYEE_TLN",
        hour_rate_eur:28,
        km_rate_eur:0,
        night_premium_pct:19,
        adr_per_km_eur:0.25,
        tln_overtime_threshold_hours:40,
        tln_overtime_pct:30,
        tln_sat_pct:50,
        tln_sun_pct:100,
        note:"TLN sözleşme örneği"
      },
      {
        contract_id:"CTR-ZZP-010",
        profile_type:"ZZP_HOURLY",
        hour_rate_eur:45,
        km_rate_eur:0,
        night_premium_pct:19,
        adr_per_km_eur:0.25,
        tln_overtime_threshold_hours:40,
        tln_overtime_pct:30,
        tln_sat_pct:50,
        tln_sun_pct:100,
        note:"ZZP saatlik örnek"
      }
    ]
  };
}

let state = null;
function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw){
    state = seedData();
    saveState();
    return;
  }
  try{
    state = JSON.parse(raw);
    if (!state.drivers) state.drivers = [];
    if (!state.contracts) state.contracts = [];
  } catch(e){
    state = seedData();
    saveState();
  }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

/* =========================
   Modal
   ========================= */
function openModal(title, html){
  const back = document.getElementById("modalBack");
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalBody").innerHTML = html;
  back.style.display = "flex";
}
function closeModal(){
  document.getElementById("modalBack").style.display = "none";
}
document.getElementById("modalClose").addEventListener("click", closeModal);
document.getElementById("modalBack").addEventListener("click", (e) => {
  if (e.target?.id === "modalBack") closeModal();
});

/* =========================
   Helpers
   ========================= */
function ptLabel(code){
  return PROFILE_TYPES.find(x=>x.code===code)?.label || code || "";
}
function getContract(contract_id){
  return state.contracts.find(c => String(c.contract_id) === String(contract_id)) || null;
}
function upsertDriver(rec){
  const idx = state.drivers.findIndex(x => String(x.driver_id) === String(rec.driver_id));
  if (idx >= 0) state.drivers[idx] = rec;
  else state.drivers.push(rec);
  saveState();
}
function removeDriver(driver_id){
  state.drivers = state.drivers.filter(x => String(x.driver_id) !== String(driver_id));
  saveState();
}
function upsertContract(rec){
  const idx = state.contracts.findIndex(x => String(x.contract_id) === String(rec.contract_id));
  if (idx >= 0) state.contracts[idx] = rec;
  else state.contracts.push(rec);
  saveState();
}
function removeContract(contract_id){
  // referans kontrolü: isteyeniz bloklayabiliriz; şimdilik uyarı verip yine siliyoruz
  const usedBy = state.drivers.filter(d => String(d.contract_id) === String(contract_id)).map(d=>d.driver_id);
  if (usedBy.length){
    const ok = confirm(`Bu sözleşme şu sürücülerde kullanılıyor: ${usedBy.join(", ")}\nYine de silinsin mi?`);
    if (!ok) return;
  }
  state.contracts = state.contracts.filter(x => String(x.contract_id) !== String(contract_id));
  // sürücüdeki contract_id’leri temizle
  state.drivers = state.drivers.map(d => (String(d.contract_id) === String(contract_id)) ? ({...d, contract_id:""}) : d);
  saveState();
}

function buildProfileTypeOptions(selected){
  return PROFILE_TYPES.map(p => {
    const sel = String(selected||"") === p.code ? "selected" : "";
    return `<option value="${esc(p.code)}" ${sel}>${esc(p.label)}</option>`;
  }).join("");
}

function buildContractOptions(selected, profileType){
  const list = state.contracts
    .filter(c => !profileType || String(c.profile_type) === String(profileType))
    .slice()
    .sort((a,b)=>String(a.contract_id).localeCompare(String(b.contract_id)));
  const opts = [`<option value="">— boş —</option>`];
  for (const c of list){
    const sel = String(selected||"") === String(c.contract_id) ? "selected" : "";
    opts.push(`<option value="${esc(c.contract_id)}" ${sel}>${esc(c.contract_id)} (${esc(ptLabel(c.profile_type))})</option>`);
  }
  return opts.join("");
}

/* =========================
   Tabs / Render
   ========================= */
const TABS = [
  {id:"drivers", label:"Sürücüler"},
  {id:"contracts", label:"Sözleşmeler"}
];
let activeTab = "drivers";

function renderTabs(){
  const el = document.getElementById("tabs");
  el.innerHTML = "";
  for (const t of TABS){
    const b = document.createElement("button");
    b.textContent = t.label;
    b.className = (activeTab === t.id) ? "active" : "";
    b.addEventListener("click", () => { activeTab = t.id; render(); });
    el.appendChild(b);
  }
}

function render(){
  renderTabs();
  const view = document.getElementById("view");
  view.innerHTML = "";
  if (activeTab === "drivers") view.appendChild(renderDrivers());
  if (activeTab === "contracts") view.appendChild(renderContracts());
}

/* =========================
   Drivers UI
   ========================= */
function renderDrivers(){
  const card = document.createElement("div");
  card.className = "card";

  const rows = state.drivers.slice().sort((a,b)=>String(a.driver_id).localeCompare(String(b.driver_id)));

  card.innerHTML = `
    <div class="row">
      <h3 style="margin:0;">Sürücüler</h3>
      <div style="flex:1"></div>
      <button class="primary" id="btnAddDriver">Yeni Sürücü</button>
    </div>
    <div class="small" style="margin-top:6px;">
      Alanlar: Sürücü ID, Ad Soyad, Profil Tipi, Sözleşme ID, Aktif/Pasif + Görüntüle/Düzenle/Sil
    </div>
    <div id="driverFormSlot"></div>

    <div class="scroller" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Sürücü ID</th>
            <th>Ad Soyad</th>
            <th>Profil Tipi</th>
            <th>Sözleşme ID</th>
            <th>Durum</th>
            <th>İşlem</th>
          </tr>
        </thead>
        <tbody id="driverTbody"></tbody>
      </table>
    </div>
  `;

  const tbody = card.querySelector("#driverTbody");
  const slot = card.querySelector("#driverFormSlot");

  function renderTable(){
    tbody.innerHTML = "";
    for (const d of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="kbd">${esc(d.driver_id)}</td>
        <td>${esc(d.full_name)}</td>
        <td>${esc(ptLabel(d.profile_type))}</td>
        <td class="kbd">${esc(d.contract_id || "")}</td>
        <td>${asBool(d.is_active) ? `<span class="pill">Aktif</span>` : `<span class="pill">Pasif</span>`}</td>
        <td>
          <button data-view="${esc(d.driver_id)}">Görüntüle</button>
          <button data-edit="${esc(d.driver_id)}">Düzenle</button>
          <button class="danger" data-del="${esc(d.driver_id)}">Sil</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function openDriverForm(existing){
    const d = existing ? {...existing} : {driver_id:"", full_name:"", profile_type:"EMPLOYEE_TLN", contract_id:"", is_active:true};
    slot.innerHTML = `
      <hr/>
      <h4 style="margin:0 0 10px;">${existing ? "Sürücü Düzenle" : "Yeni Sürücü"}</h4>
      <div class="row">
        <label>Sürücü ID *<br/><input id="d_id" type="text" value="${esc(d.driver_id)}" ${existing ? "disabled" : ""}></label>
        <label>Ad Soyad *<br/><input id="d_name" type="text" value="${esc(d.full_name)}"></label>
        <label>Profil Tipi *<br/>
          <select id="d_pt">${buildProfileTypeOptions(d.profile_type)}</select>
        </label>
        <label>Sözleşme ID<br/>
          <select id="d_contract"></select>
        </label>
        <label>Aktif / Pasif<br/>
          <select id="d_active">
            <option value="true" ${asBool(d.is_active)?"selected":""}>Aktif</option>
            <option value="false" ${!asBool(d.is_active)?"selected":""}>Pasif</option>
          </select>
        </label>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="primary" id="d_save">Kaydet</button>
        <button id="d_cancel">Vazgeç</button>
      </div>
    `;

    const ptSel = slot.querySelector("#d_pt");
    const contractSel = slot.querySelector("#d_contract");

    function refreshContracts(){
      contractSel.innerHTML = buildContractOptions(d.contract_id, ptSel.value);
      // eğer mevcut contract, profile type filter yüzünden görünmüyorsa boşalt
      const exists = Array.from(contractSel.options).some(o => o.value === String(d.contract_id||""));
      if (!exists) contractSel.value = "";
    }
    refreshContracts();
    ptSel.addEventListener("change", refreshContracts);

    slot.querySelector("#d_save").addEventListener("click", () => {
      const driver_id = slot.querySelector("#d_id").value.trim();
      const full_name = slot.querySelector("#d_name").value.trim();
      const profile_type = slot.querySelector("#d_pt").value;
      const contract_id = slot.querySelector("#d_contract").value;
      const is_active = slot.querySelector("#d_active").value === "true";

      if (!driver_id) return alert("Sürücü ID zorunludur.");
      if (!full_name) return alert("Ad Soyad zorunludur.");
      if (!profile_type) return alert("Profil Tipi zorunludur.");

      if (!existing){
        const dup = state.drivers.some(x => String(x.driver_id) === String(driver_id));
        if (dup) return alert("Bu Sürücü ID zaten var: " + driver_id);
      }

      upsertDriver({driver_id, full_name, profile_type, contract_id, is_active});
      slot.innerHTML = "";
      render(); // refresh
    });

    slot.querySelector("#d_cancel").addEventListener("click", () => slot.innerHTML = "");
  }

  card.querySelector("#btnAddDriver").addEventListener("click", () => openDriverForm(null));

  card.addEventListener("click", (e) => {
    const viewId = e.target?.getAttribute?.("data-view");
    const editId = e.target?.getAttribute?.("data-edit");
    const delId = e.target?.getAttribute?.("data-del");

    if (viewId){
      const d = state.drivers.find(x => String(x.driver_id) === String(viewId));
      if (!d) return;
      const c = d.contract_id ? getContract(d.contract_id) : null;
      openModal("Sürücü Görüntüle", `
        <table>
          <tr><th>Sürücü ID</th><td class="kbd">${esc(d.driver_id)}</td></tr>
          <tr><th>Ad Soyad</th><td>${esc(d.full_name)}</td></tr>
          <tr><th>Profil Tipi</th><td>${esc(ptLabel(d.profile_type))}</td></tr>
          <tr><th>Sözleşme ID</th><td class="kbd">${esc(d.contract_id||"")}</td></tr>
          <tr><th>Sözleşme Profil Tipi</th><td>${esc(c ? ptLabel(c.profile_type) : "")}</td></tr>
          <tr><th>Durum</th><td>${asBool(d.is_active) ? "Aktif" : "Pasif"}</td></tr>
        </table>
      `);
    }

    if (editId){
      const d = state.drivers.find(x => String(x.driver_id) === String(editId));
      if (!d) return;
      openDriverForm(d);
    }

    if (delId){
      if (!confirm("Sürücü silinsin mi?")) return;
      removeDriver(delId);
      render();
    }
  });

  renderTable();
  return card;
}

/* =========================
   Contracts UI
   ========================= */
function renderContracts(){
  const card = document.createElement("div");
  card.className = "card";

  const rows = state.contracts.slice().sort((a,b)=>String(a.contract_id).localeCompare(String(b.contract_id)));

  card.innerHTML = `
    <div class="row">
      <h3 style="margin:0;">Sözleşmeler</h3>
      <div style="flex:1"></div>
      <button class="primary" id="btnAddContract">Yeni Sözleşme</button>
    </div>
    <div class="small" style="margin-top:6px;">
      Alanlar: Sözleşme ID, Profil Tipi, Saat/KM ücreti, Gece primi, ADR, TLN haftalık overtime + Cumartesi/Pazar + Not
    </div>

    <div id="contractFormSlot"></div>

    <div class="scroller" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Sözleşme ID</th>
            <th>Profil Tipi</th>
            <th class="right">Saat €</th>
            <th class="right">KM €</th>
            <th class="right">Gece %</th>
            <th class="right">ADR €/km</th>
            <th class="right">OT Eşik</th>
            <th class="right">OT %</th>
            <th class="right">Cts %</th>
            <th class="right">Paz %</th>
            <th>Not</th>
            <th>İşlem</th>
          </tr>
        </thead>
        <tbody id="contractTbody"></tbody>
      </table>
    </div>
  `;

  const tbody = card.querySelector("#contractTbody");
  const slot = card.querySelector("#contractFormSlot");

  function renderTable(){
    tbody.innerHTML = "";
    for (const c of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="kbd">${esc(c.contract_id)}</td>
        <td>${esc(ptLabel(c.profile_type))}</td>
        <td class="right">€${fmt(num(c.hour_rate_eur))}</td>
        <td class="right">€${fmt(num(c.km_rate_eur))}</td>
        <td class="right">${fmt(num(c.night_premium_pct))}</td>
        <td class="right">€${fmt(num(c.adr_per_km_eur))}</td>
        <td class="right">${fmt(num(c.tln_overtime_threshold_hours))}</td>
        <td class="right">${fmt(num(c.tln_overtime_pct))}</td>
        <td class="right">${fmt(num(c.tln_sat_pct))}</td>
        <td class="right">${fmt(num(c.tln_sun_pct))}</td>
        <td>${esc(c.note||"")}</td>
        <td>
          <button data-view="${esc(c.contract_id)}">Görüntüle</button>
          <button data-edit="${esc(c.contract_id)}">Düzenle</button>
          <button class="danger" data-del="${esc(c.contract_id)}">Sil</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function openContractForm(existing){
    const c = existing ? {...existing} : {
      contract_id:"",
      profile_type:"EMPLOYEE_TLN",
      hour_rate_eur:0,
      km_rate_eur:0,
      night_premium_pct:19,
      adr_per_km_eur:0.25,
      tln_overtime_threshold_hours:40,
      tln_overtime_pct:30,
      tln_sat_pct:50,
      tln_sun_pct:100,
      note:""
    };

    slot.innerHTML = `
      <hr/>
      <h4 style="margin:0 0 10px;">${existing ? "Sözleşme Düzenle" : "Yeni Sözleşme"}</h4>
      <div class="row">
        <label>Sözleşme ID *<br/><input id="c_id" type="text" value="${esc(c.contract_id)}" ${existing ? "disabled" : ""}></label>
        <label>Profil Tipi *<br/>
          <select id="c_pt">${buildProfileTypeOptions(c.profile_type)}</select>
        </label>
        <label>Saat Ücreti (€)<br/><input id="c_hr" type="number" step="0.01" value="${esc(c.hour_rate_eur)}"></label>
        <label>KM Ücreti (€)<br/><input id="c_km" type="number" step="0.01" value="${esc(c.km_rate_eur)}"></label>
        <label>Gece Primi % (21:00–04:00)<br/><input id="c_night" type="number" step="0.01" value="${esc(c.night_premium_pct)}"></label>
        <label>ADR €/km<br/><input id="c_adr" type="number" step="0.01" value="${esc(c.adr_per_km_eur)}"></label>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>TLN Overtime Eşiği (haftalık)<br/><input id="c_ot_thr" type="number" step="0.01" value="${esc(c.tln_overtime_threshold_hours)}"></label>
        <label>TLN Overtime % (40 saat üstü)<br/><input id="c_ot_pct" type="number" step="0.01" value="${esc(c.tln_overtime_pct)}"></label>
        <label>TLN Cumartesi %<br/><input id="c_sat" type="number" step="0.01" value="${esc(c.tln_sat_pct)}"></label>
        <label>TLN Pazar %<br/><input id="c_sun" type="number" step="0.01" value="${esc(c.tln_sun_pct)}"></label>
      </div>

      <div style="margin-top:10px;">
        <label>Not<br/><textarea id="c_note">${esc(c.note||"")}</textarea></label>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="primary" id="c_save">Kaydet</button>
        <button id="c_cancel">Vazgeç</button>
      </div>
    `;

    slot.querySelector("#c_save").addEventListener("click", () => {
      const contract_id = slot.querySelector("#c_id").value.trim();
      const profile_type = slot.querySelector("#c_pt").value;

      if (!contract_id) return alert("Sözleşme ID zorunludur.");
      if (!profile_type) return alert("Profil Tipi zorunludur.");

      if (!existing){
        const dup = state.contracts.some(x => String(x.contract_id) === String(contract_id));
        if (dup) return alert("Bu Sözleşme ID zaten var: " + contract_id);
      }

      const rec = {
        contract_id,
        profile_type,
        hour_rate_eur: num(slot.querySelector("#c_hr").value),
        km_rate_eur: num(slot.querySelector("#c_km").value),
        night_premium_pct: num(slot.querySelector("#c_night").value),
        adr_per_km_eur: num(slot.querySelector("#c_adr").value),
        tln_overtime_threshold_hours: num(slot.querySelector("#c_ot_thr").value),
        tln_overtime_pct: num(slot.querySelector("#c_ot_pct").value),
        tln_sat_pct: num(slot.querySelector("#c_sat").value),
        tln_sun_pct: num(slot.querySelector("#c_sun").value),
        note: slot.querySelector("#c_note").value.trim()
      };

      upsertContract(rec);
      slot.innerHTML = "";
      render();
    });

    slot.querySelector("#c_cancel").addEventListener("click", () => slot.innerHTML = "");
  }

  card.querySelector("#btnAddContract").addEventListener("click", () => openContractForm(null));

  card.addEventListener("click", (e) => {
    const viewId = e.target?.getAttribute?.("data-view");
    const editId = e.target?.getAttribute?.("data-edit");
    const delId = e.target?.getAttribute?.("data-del");

    if (viewId){
      const c = state.contracts.find(x => String(x.contract_id) === String(viewId));
      if (!c) return;
      openModal("Sözleşme Görüntüle", `
        <table>
          <tr><th>Sözleşme ID</th><td class="kbd">${esc(c.contract_id)}</td></tr>
          <tr><th>Profil Tipi</th><td>${esc(ptLabel(c.profile_type))}</td></tr>
          <tr><th>Saat Ücreti (€)</th><td>€${fmt(num(c.hour_rate_eur))}</td></tr>
          <tr><th>KM Ücreti (€)</th><td>€${fmt(num(c.km_rate_eur))}</td></tr>
          <tr><th>Gece Primi % (21:00–04:00)</th><td>${fmt(num(c.night_premium_pct))}</td></tr>
          <tr><th>ADR €/km</th><td>€${fmt(num(c.adr_per_km_eur))}</td></tr>
          <tr><th>TLN Overtime Eşiği (haftalık)</th><td>${fmt(num(c.tln_overtime_threshold_hours))}</td></tr>
          <tr><th>TLN Overtime %</th><td>${fmt(num(c.tln_overtime_pct))}</td></tr>
          <tr><th>TLN Cumartesi %</th><td>${fmt(num(c.tln_sat_pct))}</td></tr>
          <tr><th>TLN Pazar %</th><td>${fmt(num(c.tln_sun_pct))}</td></tr>
          <tr><th>Not</th><td>${esc(c.note||"")}</td></tr>
        </table>
      `);
    }

    if (editId){
      const c = state.contracts.find(x => String(x.contract_id) === String(editId));
      if (!c) return;
      openContractForm(c);
    }

    if (delId){
      if (!confirm("Sözleşme silinsin mi?")) return;
      removeContract(delId);
      render();
    }
  });

  renderTable();
  return card;
}

/* =========================
   Backup / Reset
   ========================= */
document.getElementById("btnExport").addEventListener("click", () => {
  downloadText(JSON.stringify(state, null, 2), "nedline_backup.json");
});

document.getElementById("btnImport").addEventListener("click", () => {
  const input = document.getElementById("fileInput");
  input.value = "";
  input.onchange = async () => {
    const f = input.files[0];
    if (!f) return;
    const txt = await f.text();
    try{
      const obj = JSON.parse(txt);
      if (!obj.drivers || !obj.contracts) throw new Error("Format geçersiz (drivers/contracts yok).");
      state = obj;
      saveState();
      alert("Yedek içe aktarıldı.");
      render();
    } catch(e){
      alert("Yedek içe aktarılamadı: " + e.message);
    }
  };
  input.click();
});

document.getElementById("btnReset").addEventListener("click", () => {
  if (!confirm("Tüm veriler silinecek. Emin misiniz?")) return;
  localStorage.removeItem(STORAGE_KEY);
  loadState();
  render();
});

/* =========================
   Init
   ========================= */
loadState();
render();
</script>
</body>
</html>
