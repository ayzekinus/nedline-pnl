<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NedLine MVP - Dashboard + Modules</title>
  <style>
    :root {
      --b:#e6e6e6;
      --bg:#fafafa;
      --txt:#111;
      --muted:#666;
      --card:#fff;
      --shadow: 0 6px 18px rgba(0,0,0,.06);

      --pos-bg:#e9f8ef;
      --pos-txt:#0f5132;

      --neg-bg:#fdecec;
      --neg-txt:#842029;

      --warn-bg:#fff7e6;
      --warn-txt:#7a4d00;

      --chip:#f3f3f3;
    }

    body{ font-family: Arial, sans-serif; margin:18px; color:var(--txt); background:#fff; }
    h1{ margin:0 0 6px; font-size:20px; }
    .muted{ color:var(--muted); font-size:12px; line-height:1.4; }
    .topbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:12px 0 14px; }
    .tabbar{ display:flex; gap:8px; flex-wrap:wrap; }
    .tabbar button{
      border:1px solid var(--b); background:var(--bg); padding:10px 12px; border-radius:12px; cursor:pointer;
      font-size:13px;
    }
    .tabbar button.active{ background:#111; color:#fff; border-color:#111; }

    .card{ border:1px solid var(--b); border-radius:14px; padding:14px; margin-top:12px; background:var(--card); box-shadow: var(--shadow); }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; }
    label{ font-size:12px; }
    input, select, textarea{
      border:1px solid var(--b); border-radius:10px; padding:8px 10px; font-size:13px; background:#fff;
    }
    textarea{ min-height:80px; width:100%; }
    button{
      border:1px solid var(--b); background:var(--bg); padding:10px 12px; border-radius:12px; cursor:pointer;
      font-size:13px;
    }
    button.primary{ background:#111; color:#fff; border-color:#111; }
    button.primary:hover{ background:#000; }
    button.danger{ background:#fff3f3; border-color:#ffd0d0; }
    button:hover{ background:#f0f0f0; }
    hr{ border:0; border-top:1px solid #eee; margin:12px 0; }

    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th, td{ border:1px solid #eee; padding:8px; font-size:12px; vertical-align:top; }
    th{ background:#fbfbfb; text-align:left; position:sticky; top:0; z-index:1; }
    .right{ text-align:right; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--b); font-size:12px; background:#fff; }
    .scroller{ overflow:auto; max-height:520px; border:1px solid #eee; border-radius:12px; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px; }
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:14px;
      z-index: 9999;
    }
    .modal{
      background:#fff; border-radius:14px; border:1px solid #eee; padding:14px; width:min(1100px, 100%);
      box-shadow: 0 20px 60px rgba(0,0,0,.2);
    }
    .small{ font-size:11px; color:var(--muted); }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media(max-width:980px){ .grid2{ grid-template-columns:1fr; } }
    .hint{ background:#fff; border:1px dashed #ddd; border-radius:12px; padding:10px; }
    .warn{ background:var(--warn-bg); border:1px solid #ffe58f; border-radius:12px; padding:10px; color:var(--warn-txt); }

    /* Dashboard visuals */
    .kpiGrid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
    @media(max-width:1100px){ .kpiGrid{ grid-template-columns: repeat(2, 1fr); } }
    @media(max-width:560px){ .kpiGrid{ grid-template-columns: 1fr; } }

    .kpi{
      border:1px solid #eee; border-radius:14px; padding:12px; background:#fff; box-shadow: none;
    }
    .kpi .label{ font-size:12px; color:var(--muted); }
    .kpi .value{ font-size:20px; margin-top:6px; font-weight:700; }
    .kpi .sub{ font-size:12px; margin-top:6px; color:var(--muted); }

    .tagPos{ background:var(--pos-bg); color:var(--pos-txt); border:1px solid #b7e3c8; }
    .tagNeg{ background:var(--neg-bg); color:var(--neg-txt); border:1px solid #f5b5b5; }
    .tagWarn{ background:var(--warn-bg); color:var(--warn-txt); border:1px solid #ffd591; }

    .rowPos td{ background: #fbfffc; }
    .rowNeg td{ background: #fffafa; }

    .barWrap{ display:flex; flex-direction:column; gap:8px; }
    .barRow{ display:flex; align-items:center; gap:10px; }
    .barLabel{ width:160px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:12px; }
    .barTrack{ flex:1; height:14px; border-radius:999px; border:1px solid #eee; background:#fafafa; position:relative; overflow:hidden; }
    .barFillPos{ height:100%; background:#1f8b4c; border-radius:999px; }
    .barFillNeg{ height:100%; background:#c0392b; border-radius:999px; }
    .barVal{ width:110px; text-align:right; font-size:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; border:1px solid #eaeaea; background:var(--chip);
      font-size:12px;
    }
  </style>
</head>
<body>

<h1>NedLine MVP — Dashboard + Operasyon Modülleri</h1>
<div class="muted">
  Dashboard, rota bazında hesaplanan <span class="kbd">Gelir / Maliyet / Kâr</span> değerlerinden beslenir. <br/>
  Gece saat aralığı ve renk eşikleri <b>Ayarlar</b> menüsünden değiştirilebilir.
</div>

<div class="topbar">
  <div class="tabbar" id="tabs"></div>
  <div style="flex:1"></div>
  <div class="row">
    <button id="btnExport">Yedek (JSON) Dışa Aktar</button>
    <button id="btnImport">Yedek (JSON) İçe Aktar</button>
    <button class="danger" id="btnReset">Tüm Veriyi Sıfırla</button>
  </div>
</div>

<div id="view"></div>
<input type="file" id="fileInput" style="display:none" accept=".json"/>

<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="row">
      <h3 id="modalTitle" style="margin:0;">Görüntüle</h3>
      <div style="flex:1"></div>
      <button id="modalClose">Kapat</button>
    </div>
    <div id="modalBody" style="margin-top:10px;"></div>
  </div>
</div>

<script>
/* =========================
   Storage / State
   ========================= */
const STORAGE_KEY = "nedline_mvp_v3_dashboard_settings";

const PROFILE_TYPES = [
  {code:"EMPLOYEE_TLN", label:"Employe TLN"},
  {code:"ZZP_HOURLY", label:"ZZP HOURLY"},
  {code:"CHARTER_KM", label:"CHARTER KM"},
  {code:"CHARTER_HOUR", label:"CHARTER HOUR"},
  {code:"CHARTER_FIXED", label:"CHARTER FIXED"}
];

const ROUTE_DRIVER_MODE = [
  {code:"TLN", label:"TLN Sözleşmeli Sürücü"},
  {code:"ZZP", label:"ZZP Sürücü"},
  {code:"CHARTER", label:"Charter"}
];

const CHARTER_COST_MODEL = [
  {code:"FIXED", label:"Sabit (per rota)"},
  {code:"PER_KM", label:"KM Bazlı (€/km)"},
  {code:"PER_HOUR", label:"Saat Bazlı (€/saat)"}
];

const esc = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const num = (x) => {
  if (x === null || x === undefined) return 0;
  const s = String(x).trim().replace(",", ".");
  const v = parseFloat(s);
  return isNaN(v) ? 0 : v;
};
const asBool = (v) => (v === true || v === 1 || v === "1" || String(v).toLowerCase()==="true");
const fmt = (x) => (isFinite(x) ? x.toFixed(2) : "0.00");

function downloadText(text, filename, mime="application/json;charset=utf-8") {
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function defaultSettings(){
  return {
    currency_symbol: "€",
    // Gece aralığı (cross-midnight destekli)
    night_start: "21:00",
    night_end: "04:00",
    // Dashboard renk eşikleri
    // profit < 0 => kırmızı
    // 0 <= profit < profit_warn_threshold => amber
    // profit >= profit_warn_threshold => yeşil
    profit_warn_threshold: 100,
    // Dashboard default filtre
    dashboard_default_range: "ALL" // ALL | LAST_7 | THIS_MONTH
  };
}

function seedData(){
  return {
    settings: defaultSettings(),
    drivers: [
      {driver_id:"DRV-001", full_name:"Örnek TLN", profile_type:"EMPLOYEE_TLN", contract_id:"CTR-TLN-001", is_active:true},
      {driver_id:"DRV-010", full_name:"Örnek ZZP", profile_type:"ZZP_HOURLY", contract_id:"CTR-ZZP-010", is_active:true}
    ],
    contracts: [
      {
        contract_id:"CTR-TLN-001",
        profile_type:"EMPLOYEE_TLN",
        hour_rate_eur:28,
        km_rate_eur:0,
        night_premium_pct:19,
        adr_per_km_eur:0.25,
        tln_overtime_threshold_hours:40,
        tln_overtime_pct:30,
        tln_sat_pct:50,
        tln_sun_pct:100,
        note:"TLN sözleşme örneği"
      },
      {
        contract_id:"CTR-ZZP-010",
        profile_type:"ZZP_HOURLY",
        hour_rate_eur:45,
        km_rate_eur:0,
        night_premium_pct:19,
        adr_per_km_eur:0.25,
        tln_overtime_threshold_hours:40,
        tln_overtime_pct:30,
        tln_sat_pct:50,
        tln_sun_pct:100,
        note:"ZZP saatlik örnek"
      }
    ],
    tours: [
      {
        tour_id: "TUR-0001",
        start_address: "1438AN Oude Meer, Hollanda",
        via_stops: "Stop 1: Amsterdam\nStop 2: Utrecht",
        end_address: "Rotterdam, Hollanda",
        customer: "CUST-01",
        start_dt: "2026-01-05T08:00",
        end_dt: "2026-01-05T18:00",
        tour_price_eur: 650,
        tour_km: 180,
        vehicle_type: "Tautliner",
      },
      {
        tour_id: "TUR-0002",
        start_address: "Rotterdam",
        via_stops: "",
        end_address: "Antwerp",
        customer: "CUST-01",
        start_dt: "2026-01-05T19:30",
        end_dt: "2026-01-05T23:30",
        tour_price_eur: 300,
        tour_km: 120,
        vehicle_type: "Box",
      }
    ],
    charters: [
      {vendor_id:"CH-001", vendor_name:"Charter 1", is_active:true}
    ],
    charter_vehicles: [
      {vehicle_id:"CH1-A", vendor_id:"CH-001", vehicle_name:"Araç A", cost_model:"FIXED", fixed_fee_eur:250, km_rate_eur:0, hour_rate_eur:0, is_active:true, note:"Sabit"},
      {vehicle_id:"CH1-B", vendor_id:"CH-001", vehicle_name:"Araç B", cost_model:"PER_KM", fixed_fee_eur:0, km_rate_eur:0.85, hour_rate_eur:0, is_active:true, note:"KM"},
      {vehicle_id:"CH1-C", vendor_id:"CH-001", vehicle_name:"Araç C", cost_model:"PER_HOUR", fixed_fee_eur:0, km_rate_eur:0, hour_rate_eur:45, is_active:true, note:"Saat"}
    ],
    routes: [
      {
        route_no: "NED001",
        driver_mode: "CHARTER",
        driver_id: "",
        charter_vendor_id: "CH-001",
        charter_vehicle_id: "CH1-A",
        charter_cost_override_enabled: true,
        charter_cost_override_eur: 250,
        sales_price_eur: 0,
        tour_ids: ["TUR-0001","TUR-0002"],
        note: "Örnek rota (override ile)"
      }
    ]
  };
}

let state = null;

function mergeSettings(existing){
  const d = defaultSettings();
  return {...d, ...(existing||{})};
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw){
    state = seedData();
    saveState();
    return;
  }
  try{
    state = JSON.parse(raw);
    if (!state.settings) state.settings = defaultSettings();
    state.settings = mergeSettings(state.settings);

    if (!state.drivers) state.drivers = [];
    if (!state.contracts) state.contracts = [];
    if (!state.tours) state.tours = [];
    if (!state.routes) state.routes = [];
    if (!state.charters) state.charters = [];
    if (!state.charter_vehicles) state.charter_vehicles = [];

    // tours migration: eksik alanları tamamla
    state.tours = state.tours.map(t => ({
      tour_id: "",
      start_address: "",
      via_stops: "",
      end_address: "",
      customer: "",
      start_dt: "",
      end_dt: "",
      tour_price_eur: 0,
      tour_km: 0,
      vehicle_type: "",
      ...t
    }));

    // routes migration
    state.routes = state.routes.map(r => ({
      charter_vendor_id: r.charter_vendor_id || "",
      charter_vehicle_id: r.charter_vehicle_id || "",
      charter_cost_override_eur: r.charter_cost_override_eur || 0,
      charter_cost_override_enabled: (r.charter_cost_override_enabled !== undefined) ? r.charter_cost_override_enabled : false,
      ...r
    }));

  } catch(e){
    state = seedData();
    saveState();
  }
}

function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

/* =========================
   Modal
   ========================= */
function openModal(title, html){
  const back = document.getElementById("modalBack");
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalBody").innerHTML = html;
  back.style.display = "flex";
}
function closeModal(){ document.getElementById("modalBack").style.display = "none"; }
document.getElementById("modalClose").addEventListener("click", closeModal);
document.getElementById("modalBack").addEventListener("click", (e) => {
  if (e.target?.id === "modalBack") closeModal();
});

/* =========================
   Time calculations (settings-based night window)
   ========================= */
function nextMidnight(d){ const x = new Date(d); x.setHours(24,0,0,0); return x; }
function sameDayMidnight(d){ const x = new Date(d); x.setHours(0,0,0,0); return x; }
function overlapMinutes(aStart, aEnd, bStart, bEnd){
  const s = Math.max(aStart.getTime(), bStart.getTime());
  const e = Math.min(aEnd.getTime(), bEnd.getTime());
  const diff = e - s;
  return diff > 0 ? diff/60000 : 0;
}
function parseHHMM(s){
  const m = String(s||"").match(/^(\d{1,2}):(\d{2})$/);
  if (!m) return null;
  const hh = Math.max(0, Math.min(23, parseInt(m[1],10)));
  const mm = Math.max(0, Math.min(59, parseInt(m[2],10)));
  return {hh, mm};
}
function computeNightOverlapForDay(segStart, segEnd, dayMid, nightStart, nightEnd){
  // nightStart/nightEnd: {hh,mm}
  // cross-midnight destekli
  const startMin = nightStart.hh*60 + nightStart.mm;
  const endMin = nightEnd.hh*60 + nightEnd.mm;

  let nightMin = 0;

  if (startMin === endMin) return 0; // 24 saat night gibi yorumlamıyoruz; pratikte kapalı

  if (startMin < endMin){
    // same-day window (örn 22:00-23:00)
    const wS = new Date(dayMid); wS.setHours(nightStart.hh, nightStart.mm, 0, 0);
    const wE = new Date(dayMid); wE.setHours(nightEnd.hh, nightEnd.mm, 0, 0);
    nightMin += overlapMinutes(segStart, segEnd, wS, wE);
  } else {
    // cross-midnight window (örn 21:00-04:00)
    const w1S = new Date(dayMid); w1S.setHours(nightStart.hh, nightStart.mm, 0, 0);
    const w1E = new Date(dayMid); w1E.setHours(24,0,0,0);
    nightMin += overlapMinutes(segStart, segEnd, w1S, w1E);

    const w2S = new Date(dayMid); w2S.setHours(0,0,0,0);
    const w2E = new Date(dayMid); w2E.setHours(nightEnd.hh, nightEnd.mm, 0, 0);
    nightMin += overlapMinutes(segStart, segEnd, w2S, w2E);
  }
  return nightMin;
}

function computeTimeMetrics(startStr, endStr){
  if (!startStr || !endStr) return null;
  const start = new Date(startStr);
  const end = new Date(endStr);
  if (isNaN(start) || isNaN(end) || end <= start) return null;

  const nightStart = parseHHMM(state?.settings?.night_start) || {hh:21, mm:0};
  const nightEnd   = parseHHMM(state?.settings?.night_end)   || {hh:4, mm:0};

  let totalMin = (end - start)/60000;
  let nightMin = 0;
  let satMin = 0;
  let sunMin = 0;

  let cursor = new Date(start);
  while (cursor < end){
    const segEnd = new Date(Math.min(nextMidnight(cursor).getTime(), end.getTime()));
    const dayMid = sameDayMidnight(cursor);

    const dow = cursor.getDay(); // 0 Sun ... 6 Sat
    const segMinutes = (segEnd - cursor)/60000;
    if (dow === 6) satMin += segMinutes;
    if (dow === 0) sunMin += segMinutes;

    nightMin += computeNightOverlapForDay(cursor, segEnd, dayMid, nightStart, nightEnd);

    cursor = segEnd;
  }

  return {
    total_hours: totalMin/60,
    night_hours: nightMin/60,
    sat_hours: satMin/60,
    sun_hours: sunMin/60
  };
}

/* =========================
   Helpers / CRUD
   ========================= */
function ptLabel(code){ return PROFILE_TYPES.find(x=>x.code===code)?.label || code || ""; }
function routeModeLabel(code){ return ROUTE_DRIVER_MODE.find(x=>x.code===code)?.label || code || ""; }
function charterModelLabel(code){ return CHARTER_COST_MODEL.find(x=>x.code===code)?.label || code || ""; }

function currency(){ return state?.settings?.currency_symbol || "€"; }
function money(x){ return `${currency()}${fmt(num(x))}`; }

function getContract(contract_id){ return state.contracts.find(c => String(c.contract_id) === String(contract_id)) || null; }
function getDriver(driver_id){ return state.drivers.find(d => String(d.driver_id) === String(driver_id)) || null; }
function getTour(tour_id){ return state.tours.find(t => String(t.tour_id) === String(tour_id)) || null; }
function getCharter(vendor_id){ return state.charters.find(v => String(v.vendor_id)===String(vendor_id)) || null; }
function getCharterVehicle(vehicle_id){ return state.charter_vehicles.find(v => String(v.vehicle_id)===String(vehicle_id)) || null; }

function upsertDriver(rec){
  const idx = state.drivers.findIndex(x => String(x.driver_id) === String(rec.driver_id));
  if (idx >= 0) state.drivers[idx] = rec; else state.drivers.push(rec);
  saveState();
}
function removeDriver(driver_id){
  state.drivers = state.drivers.filter(x => String(x.driver_id) !== String(driver_id));
  state.routes = state.routes.map(r => (String(r.driver_id)===String(driver_id)) ? ({...r, driver_id:""}) : r);
  saveState();
}
function upsertContract(rec){
  const idx = state.contracts.findIndex(x => String(x.contract_id) === String(rec.contract_id));
  if (idx >= 0) state.contracts[idx] = rec; else state.contracts.push(rec);
  saveState();
}
function removeContract(contract_id){
  const usedBy = state.drivers.filter(d => String(d.contract_id) === String(contract_id)).map(d=>d.driver_id);
  if (usedBy.length){
    const ok = confirm(`Bu sözleşme şu sürücülerde kullanılıyor: ${usedBy.join(", ")}\nYine de silinsin mi?`);
    if (!ok) return;
  }
  state.contracts = state.contracts.filter(x => String(x.contract_id) !== String(contract_id));
  state.drivers = state.drivers.map(d => (String(d.contract_id) === String(contract_id)) ? ({...d, contract_id:""}) : d);
  saveState();
}
function upsertTour(rec){
  const idx = state.tours.findIndex(x => String(x.tour_id) === String(rec.tour_id));
  if (idx >= 0) state.tours[idx] = rec; else state.tours.push(rec);
  saveState();
}
function removeTour(tour_id){
  state.routes = state.routes.map(r => ({...r, tour_ids: (r.tour_ids||[]).filter(id => String(id)!==String(tour_id))}));
  state.tours = state.tours.filter(x => String(x.tour_id) !== String(tour_id));
  saveState();
}
function upsertCharter(rec){
  const idx = state.charters.findIndex(x => String(x.vendor_id)===String(rec.vendor_id));
  if (idx>=0) state.charters[idx]=rec; else state.charters.push(rec);
  saveState();
}
function removeCharter(vendor_id){
  const used = state.charter_vehicles.some(v => String(v.vendor_id)===String(vendor_id));
  if (used){
    const ok = confirm("Bu charter'a bağlı araçlar var. Silmek araçları da etkiler. Devam edilsin mi?");
    if (!ok) return;
  }
  state.charter_vehicles = state.charter_vehicles.filter(v => String(v.vendor_id)!==String(vendor_id));
  state.routes = state.routes.map(r => (String(r.charter_vendor_id)===String(vendor_id)) ? ({...r, charter_vendor_id:"", charter_vehicle_id:""}) : r);
  state.charters = state.charters.filter(v => String(v.vendor_id)!==String(vendor_id));
  saveState();
}
function upsertCharterVehicle(rec){
  const idx = state.charter_vehicles.findIndex(x => String(x.vehicle_id)===String(rec.vehicle_id));
  if (idx>=0) state.charter_vehicles[idx]=rec; else state.charter_vehicles.push(rec);
  saveState();
}
function removeCharterVehicle(vehicle_id){
  state.routes = state.routes.map(r => (String(r.charter_vehicle_id)===String(vehicle_id)) ? ({...r, charter_vehicle_id:""}) : r);
  state.charter_vehicles = state.charter_vehicles.filter(v => String(v.vehicle_id)!==String(vehicle_id));
  saveState();
}
function upsertRoute(rec){
  const idx = state.routes.findIndex(x => String(x.route_no) === String(rec.route_no));
  if (idx >= 0) state.routes[idx] = rec; else state.routes.push(rec);
  saveState();
}
function removeRoute(route_no){
  state.routes = state.routes.filter(x => String(x.route_no) !== String(route_no));
  saveState();
}

function buildProfileTypeOptions(selected){
  return PROFILE_TYPES.map(p => `<option value="${esc(p.code)}" ${String(selected||"")===p.code?"selected":""}>${esc(p.label)}</option>`).join("");
}
function buildContractOptions(selected, profileType){
  const list = state.contracts.filter(c => !profileType || String(c.profile_type)===String(profileType))
    .slice().sort((a,b)=>String(a.contract_id).localeCompare(String(b.contract_id)));
  const opts = [`<option value="">— boş —</option>`];
  for (const c of list){
    opts.push(`<option value="${esc(c.contract_id)}" ${String(selected||"")===String(c.contract_id)?"selected":""}>${esc(c.contract_id)} (${esc(ptLabel(c.profile_type))})</option>`);
  }
  return opts.join("");
}
function buildDriverOptionsByMode(selected, mode){
  let wantedProfile = "";
  if (mode === "TLN") wantedProfile = "EMPLOYEE_TLN";
  if (mode === "ZZP") wantedProfile = "ZZP_HOURLY";

  const drivers = state.drivers
    .filter(d => asBool(d.is_active))
    .filter(d => !wantedProfile || String(d.profile_type)===wantedProfile)
    .slice().sort((a,b)=>String(a.driver_id).localeCompare(String(b.driver_id)));

  const opts = [`<option value="">— seçin —</option>`];
  for (const d of drivers){
    opts.push(`<option value="${esc(d.driver_id)}" ${String(selected||"")===String(d.driver_id)?"selected":""}>${esc(d.driver_id)} | ${esc(d.full_name)}</option>`);
  }
  return opts.join("");
}
function buildCharterVendorOptions(selected){
  const list = state.charters.filter(v=>asBool(v.is_active)).slice().sort((a,b)=>String(a.vendor_id).localeCompare(String(b.vendor_id)));
  const opts = [`<option value="">— seçin —</option>`];
  for (const v of list){
    opts.push(`<option value="${esc(v.vendor_id)}" ${String(selected||"")===String(v.vendor_id)?"selected":""}>${esc(v.vendor_id)} | ${esc(v.vendor_name)}</option>`);
  }
  return opts.join("");
}
function buildCharterVehicleOptions(selected, vendor_id){
  const list = state.charter_vehicles
    .filter(v=>asBool(v.is_active))
    .filter(v=>!vendor_id || String(v.vendor_id)===String(vendor_id))
    .slice().sort((a,b)=>String(a.vehicle_id).localeCompare(String(b.vehicle_id)));
  const opts = [`<option value="">— seçin —</option>`];
  for (const v of list){
    opts.push(`<option value="${esc(v.vehicle_id)}" ${String(selected||"")===String(v.vehicle_id)?"selected":""}>${esc(v.vehicle_id)} | ${esc(v.vehicle_name)} (${esc(charterModelLabel(v.cost_model))})</option>`);
  }
  return opts.join("");
}

/* =========================
   Route calculation
   ========================= */
function calcRouteNumbers(route){
  const tourIds = route.tour_ids || [];

  let tourRevenue = 0;
  let totalKm = 0;

  let totalH = 0, nightH = 0, satH = 0, sunH = 0;

  // Tarih: earliest start_dt (dashboard filtre için)
  let minStart = null;
  let maxEnd = null;

  for (const id of tourIds){
    const t = getTour(id);
    if (!t) continue;

    tourRevenue += num(t.tour_price_eur);
    totalKm += num(t.tour_km);

    if (t.start_dt){
      const ds = new Date(t.start_dt);
      if (!isNaN(ds)) minStart = (minStart===null || ds < minStart) ? ds : minStart;
    }
    if (t.end_dt){
      const de = new Date(t.end_dt);
      if (!isNaN(de)) maxEnd = (maxEnd===null || de > maxEnd) ? de : maxEnd;
    }

    const m = computeTimeMetrics(t.start_dt, t.end_dt);
    if (m){
      totalH += m.total_hours;
      nightH += m.night_hours;
      satH += m.sat_hours;
      sunH += m.sun_hours;
    }
  }

  const revenueUsed = num(route.sales_price_eur) > 0 ? num(route.sales_price_eur) : tourRevenue;

  let driverCost = 0;
  let charterCost = 0;
  let charterCostComputed = 0;

  const mode = String(route.driver_mode || "CHARTER");

  if (mode === "CHARTER"){
    const cv = route.charter_vehicle_id ? getCharterVehicle(route.charter_vehicle_id) : null;
    if (cv){
      if (cv.cost_model === "FIXED") charterCostComputed = num(cv.fixed_fee_eur);
      if (cv.cost_model === "PER_KM") charterCostComputed = num(cv.km_rate_eur) * totalKm;
      if (cv.cost_model === "PER_HOUR") charterCostComputed = num(cv.hour_rate_eur) * totalH;
    } else {
      charterCostComputed = 0;
    }

    const overrideEnabled = asBool(route.charter_cost_override_enabled);
    const overrideValue = num(route.charter_cost_override_eur);
    charterCost = overrideEnabled ? overrideValue : charterCostComputed;
  }

  if (mode === "TLN" || mode === "ZZP"){
    const d = route.driver_id ? getDriver(route.driver_id) : null;
    const c = d?.contract_id ? getContract(d.contract_id) : null;

    const hourRate = num(c?.hour_rate_eur);
    const nightPct = num(c?.night_premium_pct);
    const satPct = num(c?.tln_sat_pct);
    const sunPct = num(c?.tln_sun_pct);

    if (hourRate > 0){
      driverCost += hourRate * totalH;
      if (nightPct > 0) driverCost += hourRate * nightH * (nightPct/100);

      // TLN için hafta sonu primi
      if (mode === "TLN"){
        if (satPct > 0) driverCost += hourRate * satH * (satPct/100);
        if (sunPct > 0) driverCost += hourRate * sunH * (sunPct/100);
      }
    }
  }

  const costUsed = (mode === "CHARTER") ? charterCost : driverCost;
  const profit = revenueUsed - costUsed;
  const marginPct = (revenueUsed > 0) ? (profit / revenueUsed * 100) : 0;

  return {
    route_start_dt: minStart ? minStart.toISOString().slice(0,16) : "",
    route_end_dt: maxEnd ? maxEnd.toISOString().slice(0,16) : "",

    tour_revenue_eur: tourRevenue,
    revenue_used_eur: revenueUsed,

    total_km: totalKm,
    total_hours: totalH,
    night_hours: nightH,
    sat_hours: satH,
    sun_hours: sunH,

    driver_cost_eur: driverCost,
    charter_cost_eur: charterCost,
    charter_cost_computed_eur: charterCostComputed,
    cost_used_eur: costUsed,

    profit_eur: profit,
    margin_pct: marginPct
  };
}

/* =========================
   Tabs / Render
   ========================= */
const TABS = [
  {id:"dashboard", label:"Dashboard"},
  {id:"contracts", label:"Sözleşmeler"},
  {id:"drivers", label:"Sürücüler"},
  {id:"tours", label:"Turlar"},
  {id:"routes", label:"Rotalar"},
  {id:"charters", label:"Charterlar"},
  {id:"settings", label:"Ayarlar"}
];

let activeTab = "dashboard";

function renderTabs(){
  const el = document.getElementById("tabs");
  el.innerHTML = "";
  for (const t of TABS){
    const b = document.createElement("button");
    b.textContent = t.label;
    b.className = (activeTab === t.id) ? "active" : "";
    b.addEventListener("click", () => { activeTab = t.id; render(); });
    el.appendChild(b);
  }
}

function render(){
  renderTabs();
  const view = document.getElementById("view");
  view.innerHTML = "";
  if (activeTab === "dashboard") view.appendChild(renderDashboard());
  if (activeTab === "contracts") view.appendChild(renderContracts());
  if (activeTab === "drivers") view.appendChild(renderDrivers());
  if (activeTab === "tours") view.appendChild(renderTours());
  if (activeTab === "routes") view.appendChild(renderRoutes());
  if (activeTab === "charters") view.appendChild(renderCharters());
  if (activeTab === "settings") view.appendChild(renderSettings());
}

/* =========================
   Dashboard
   ========================= */
function toDateOnlyISO(d){
  const x = new Date(d);
  if (isNaN(x)) return "";
  const yyyy = x.getFullYear();
  const mm = String(x.getMonth()+1).padStart(2,"0");
  const dd = String(x.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function startOfMonth(d){
  const x = new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x;
}
function addDays(d, n){
  const x = new Date(d); x.setDate(x.getDate()+n); return x;
}
function inRange(dateStr, fromDateStr, toDateStr){
  if (!fromDateStr && !toDateStr) return true;
  const d = new Date(dateStr);
  if (isNaN(d)) return false;
  if (fromDateStr){
    const f = new Date(fromDateStr+"T00:00");
    if (!isNaN(f) && d < f) return false;
  }
  if (toDateStr){
    const t = new Date(toDateStr+"T23:59");
    if (!isNaN(t) && d > t) return false;
  }
  return true;
}

function profitClass(p){
  const warn = num(state?.settings?.profit_warn_threshold);
  if (p < 0) return "tagNeg";
  if (p < warn) return "tagWarn";
  return "tagPos";
}
function renderDashboard(){
  const card = document.createElement("div");
  card.className = "card";

  // Default date range
  const now = new Date();
  const def = state.settings.dashboard_default_range || "ALL";
  let defFrom = "";
  let defTo = "";
  if (def === "LAST_7"){
    defFrom = toDateOnlyISO(addDays(now, -7));
    defTo = toDateOnlyISO(now);
  } else if (def === "THIS_MONTH"){
    defFrom = toDateOnlyISO(startOfMonth(now));
    defTo = toDateOnlyISO(now);
  }

  card.innerHTML = `
    <div class="row">
      <h3 style="margin:0;">Dashboard</h3>
      <div style="flex:1"></div>
      <span class="chip">Para Birimi: <b>${esc(currency())}</b></span>
      <span class="chip">Gece: <b>${esc(state.settings.night_start)}–${esc(state.settings.night_end)}</b></span>
    </div>

    <div class="row" style="margin-top:10px;">
      <label>Başlangıç (opsiyonel)<br/><input id="db_from" type="date" value="${esc(defFrom)}"></label>
      <label>Bitiş (opsiyonel)<br/><input id="db_to" type="date" value="${esc(defTo)}"></label>

      <label>Hızlı Filtre<br/>
        <select id="db_quick">
          <option value="KEEP">—</option>
          <option value="ALL">Tümü</option>
          <option value="LAST_7">Son 7 Gün</option>
          <option value="THIS_MONTH">Bu Ay</option>
        </select>
      </label>

      <label>Zarar Gösterimi<br/>
        <select id="db_loss_only">
          <option value="false">Tümü</option>
          <option value="true">Sadece Zarar</option>
        </select>
      </label>

      <button class="primary" id="db_apply">Uygula</button>
    </div>

    <div class="kpiGrid" style="margin-top:12px;" id="kpiGrid"></div>

    <div class="grid2" style="margin-top:12px;">
      <div class="card" style="box-shadow:none;">
        <h4 style="margin:0 0 8px;">Kâr/Zarar Dağılımı (Top 10 mutlak değer)</h4>
        <div class="barWrap" id="barWrap"></div>
      </div>

      <div class="card" style="box-shadow:none;">
        <h4 style="margin:0 0 8px;">En İyi / En Kötü Rotalar</h4>
        <div class="scroller" style="max-height:360px;">
          <table>
            <thead>
              <tr>
                <th>Rota</th><th>Tarih</th><th class="right">Gelir</th><th class="right">Maliyet</th><th class="right">Kâr</th><th class="right">Marj %</th>
              </tr>
            </thead>
            <tbody id="bestWorstBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card" style="box-shadow:none; margin-top:12px;">
      <h4 style="margin:0 0 8px;">Filtrelenmiş Rotalar</h4>
      <div class="scroller" style="max-height:420px;">
        <table>
          <thead>
            <tr>
              <th>Rota</th><th>Sürücü Tipi</th><th>Tarih</th>
              <th class="right">Tur Gelir</th><th class="right">Gelir Kullanılan</th>
              <th class="right">Maliyet</th><th class="right">Kâr</th><th class="right">Marj %</th>
              <th>Override?</th>
              <th>İşlem</th>
            </tr>
          </thead>
          <tbody id="routesBody"></tbody>
        </table>
      </div>
    </div>
  `;

  const fromEl = card.querySelector("#db_from");
  const toEl = card.querySelector("#db_to");
  const quickEl = card.querySelector("#db_quick");
  const lossOnlyEl = card.querySelector("#db_loss_only");
  const applyBtn = card.querySelector("#db_apply");

  const kpiGrid = card.querySelector("#kpiGrid");
  const barWrap = card.querySelector("#barWrap");
  const bestWorstBody = card.querySelector("#bestWorstBody");
  const routesBody = card.querySelector("#routesBody");

  function routeDisplayDate(n){
    // route_start_dt ISO => date only
    if (!n.route_start_dt) return "";
    return n.route_start_dt.slice(0,10);
  }

  function computeFiltered(){
    const from = fromEl.value;
    const to = toEl.value;
    const lossOnly = (lossOnlyEl.value === "true");

    const list = state.routes.map(r => {
      const n = calcRouteNumbers(r);
      const dt = routeDisplayDate(n);
      return {r, n, dt};
    }).filter(x => x.dt && inRange(x.dt, from, to));

    const filtered = lossOnly ? list.filter(x => num(x.n.profit_eur) < 0) : list;
    return filtered;
  }

  function renderKpis(list){
    const totalRevenue = list.reduce((a,x)=>a+num(x.n.revenue_used_eur), 0);
    const totalCost = list.reduce((a,x)=>a+num(x.n.cost_used_eur), 0);
    const totalProfit = list.reduce((a,x)=>a+num(x.n.profit_eur), 0);
    const routesCount = list.length;
    const lossCount = list.filter(x=>num(x.n.profit_eur) < 0).length;
    const posCount = routesCount - lossCount;
    const margin = totalRevenue > 0 ? (totalProfit/totalRevenue*100) : 0;

    const profitCls = profitClass(totalProfit);

    kpiGrid.innerHTML = `
      <div class="kpi">
        <div class="label">Toplam Gelir (kullanılan)</div>
        <div class="value">${money(totalRevenue)}</div>
        <div class="sub">Filtrelenmiş rotalar</div>
      </div>

      <div class="kpi">
        <div class="label">Toplam Maliyet</div>
        <div class="value">${money(totalCost)}</div>
        <div class="sub">TLN/ZZP/Charter</div>
      </div>

      <div class="kpi">
        <div class="label">Toplam Kâr/Zarar</div>
        <div class="value"><span class="pill ${profitCls}">${money(totalProfit)}</span></div>
        <div class="sub">Marj: ${margin.toFixed(2)}%</div>
      </div>

      <div class="kpi">
        <div class="label">Rota Sayısı</div>
        <div class="value">${routesCount}</div>
        <div class="sub"><span class="pill tagPos">Kârlı: ${posCount}</span> <span class="pill tagNeg">Zararlı: ${lossCount}</span></div>
      </div>
    `;
  }

  function renderBars(list){
    // Top 10 by absolute profit
    const top = list.slice()
      .sort((a,b)=>Math.abs(num(b.n.profit_eur)) - Math.abs(num(a.n.profit_eur)))
      .slice(0,10);

    const maxAbs = top.reduce((m,x)=>Math.max(m, Math.abs(num(x.n.profit_eur))), 1);

    barWrap.innerHTML = "";
    for (const x of top){
      const p = num(x.n.profit_eur);
      const w = Math.max(2, Math.round(Math.abs(p)/maxAbs*100));
      const isNeg = p < 0;

      const row = document.createElement("div");
      row.className = "barRow";
      row.innerHTML = `
        <div class="barLabel" title="${esc(x.r.route_no)}">${esc(x.r.route_no)}</div>
        <div class="barTrack">
          <div class="${isNeg ? "barFillNeg" : "barFillPos"}" style="width:${w}%;"></div>
        </div>
        <div class="barVal">${money(p)}</div>
      `;
      barWrap.appendChild(row);
    }

    if (!top.length){
      barWrap.innerHTML = `<div class="muted">Filtreye uygun rota bulunamadı.</div>`;
    }
  }

  function renderBestWorst(list){
    bestWorstBody.innerHTML = "";

    const sorted = list.slice().sort((a,b)=>num(b.n.profit_eur) - num(a.n.profit_eur));
    const best = sorted.slice(0,5);
    const worst = sorted.slice(-5).reverse();

    function addSection(title){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="6" style="background:#fbfbfb;"><b>${esc(title)}</b></td>`;
      bestWorstBody.appendChild(tr);
    }

    addSection("En İyi 5");
    for (const x of best){
      const p = num(x.n.profit_eur);
      const cls = profitClass(p);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="kbd">${esc(x.r.route_no)}</td>
        <td class="kbd">${esc(x.dt||"")}</td>
        <td class="right">${money(x.n.revenue_used_eur)}</td>
        <td class="right">${money(x.n.cost_used_eur)}</td>
        <td class="right"><span class="pill ${cls}">${money(p)}</span></td>
        <td class="right">${num(x.n.margin_pct).toFixed(2)}%</td>
      `;
      bestWorstBody.appendChild(tr);
    }

    addSection("En Kötü 5");
    for (const x of worst){
      const p = num(x.n.profit_eur);
      const cls = profitClass(p);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="kbd">${esc(x.r.route_no)}</td>
        <td class="kbd">${esc(x.dt||"")}</td>
        <td class="right">${money(x.n.revenue_used_eur)}</td>
        <td class="right">${money(x.n.cost_used_eur)}</td>
        <td class="right"><span class="pill ${cls}">${money(p)}</span></td>
        <td class="right">${num(x.n.margin_pct).toFixed(2)}%</td>
      `;
      bestWorstBody.appendChild(tr);
    }

    if (!list.length){
      bestWorstBody.innerHTML = `<tr><td colspan="6" class="muted">Veri yok.</td></tr>`;
    }
  }

  function renderRoutesTable(list){
    routesBody.innerHTML = "";
    const sorted = list.slice().sort((a,b)=> (new Date(b.dt) - new Date(a.dt)) || (num(b.n.profit_eur) - num(a.n.profit_eur)));

    for (const x of sorted){
      const p = num(x.n.profit_eur);
      const cls = profitClass(p);
      const isNeg = p < 0;
      const override = (x.r.driver_mode==="CHARTER") ? (asBool(x.r.charter_cost_override_enabled) ? "Evet" : "Hayır") : "-";

      const tr = document.createElement("tr");
      tr.className = isNeg ? "rowNeg" : "rowPos";
      tr.innerHTML = `
        <td class="kbd">${esc(x.r.route_no)}</td>
        <td>${esc(routeModeLabel(x.r.driver_mode))}</td>
        <td class="kbd">${esc(x.dt||"")}</td>
        <td class="right">${money(x.n.tour_revenue_eur)}</td>
        <td class="right">${money(x.n.revenue_used_eur)}</td>
        <td class="right">${money(x.n.cost_used_eur)}</td>
        <td class="right"><span class="pill ${cls}">${money(p)}</span></td>
        <td class="right">${num(x.n.margin_pct).toFixed(2)}%</td>
        <td>${override}</td>
        <td><button data-open="${esc(x.r.route_no)}">Aç</button></td>
      `;
      routesBody.appendChild(tr);
    }

    if (!sorted.length){
      routesBody.innerHTML = `<tr><td colspan="10" class="muted">Filtreye uygun rota yok.</td></tr>`;
    }
  }

  function apply(){
    // quick selection
    const q = quickEl.value;
    if (q === "ALL"){
      fromEl.value = "";
      toEl.value = "";
    } else if (q === "LAST_7"){
      fromEl.value = toDateOnlyISO(addDays(new Date(), -7));
      toEl.value = toDateOnlyISO(new Date());
    } else if (q === "THIS_MONTH"){
      fromEl.value = toDateOnlyISO(startOfMonth(new Date()));
      toEl.value = toDateOnlyISO(new Date());
    }

    const filtered = computeFiltered();
    renderKpis(filtered);
    renderBars(filtered);
    renderBestWorst(filtered);
    renderRoutesTable(filtered);
  }

  applyBtn.addEventListener("click", apply);

  // open route from dashboard
  card.addEventListener("click", (e) => {
    const id = e.target?.getAttribute?.("data-open");
    if (!id) return;
    activeTab = "routes";
    render();
    // kullanıcı rotalar ekranında ilgili satırı manuel görebilir; isterseniz otomatik view açmayı da ekleyebiliriz
  });

  // initial
  apply();
  return card;
}

/* =========================
   Drivers UI
   ========================= */
function renderDrivers(){
  const card = document.createElement("div");
  card.className = "card";
  const rows = state.drivers.slice().sort((a,b)=>String(a.driver_id).localeCompare(String(b.driver_id)));

  card.innerHTML = `
    <div class="row">
      <h3 style="margin:0;">Sürücüler</h3>
      <div style="flex:1"></div>
      <button class="primary" id="btnAddDriver">Yeni Sürücü</button>
    </div>
    <div class="small" style="margin-top:6px;">Sürücü ID, Ad Soyad, Profil Tipi, Sözleşme ID, Aktif/Pasif</div>
    <div id="driverFormSlot"></div>
    <div class="scroller" style="margin-top:12px;">
      <table>
        <thead><tr><th>Sürücü ID</th><th>Ad Soyad</th><th>Profil Tipi</th><th>Sözleşme ID</th><th>Durum</th><th>İşlem</th></tr></thead>
        <tbody id="driverTbody"></tbody>
      </table>
    </div>
  `;

  const tbody = card.querySelector("#driverTbody");
  const slot = card.querySelector("#driverFormSlot");

  function renderTable(){
    tbody.innerHTML = "";
    for (const d of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="kbd">${esc(d.driver_id)}</td>
        <td>${esc(d.full_name)}</td>
        <td>${esc(ptLabel(d.profile_type))}</td>
        <td class="kbd">${esc(d.contract_id || "")}</td>
        <td>${asBool(d.is_active) ? `<span class="pill">Aktif</span>` : `<span class="pill">Pasif</span>`}</td>
        <td>
          <button data-view="${esc(d.driver_id)}">Görüntüle</button>
          <button data-edit="${esc(d.driver_id)}">Düzenle</button>
          <button class="danger" data-del="${esc(d.driver_id)}">Sil</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function openDriverForm(existing){
    const d = existing ? {...existing} : {driver_id:"", full_name:"", profile_type:"EMPLOYEE_TLN", contract_id:"", is_active:true};
    slot.innerHTML = `
      <hr/>
      <h4 style="margin:0 0 10px;">${existing ? "Sürücü Düzenle" : "Yeni Sürücü"}</h4>
      <div class="row">
        <label>Sürücü ID *<br/><input id="d_id" type="text" value="${esc(d.driver_id)}" ${existing ? "disabled" : ""}></label>
        <label>Ad Soyad *<br/><input id="d_name" type="text" value="${esc(d.full_name)}"></label>
        <label>Profil Tipi *<br/><select id="d_pt">${buildProfileTypeOptions(d.profile_type)}</select></label>
        <label>Sözleşme ID<br/><select id="d_contract"></select></label>
        <label>Aktif / Pasif<br/>
          <select id="d_active">
            <option value="true" ${asBool(d.is_active)?"selected":""}>Aktif</option>
            <option value="false" ${!asBool(d.is_active)?"selected":""}>Pasif</option>
          </select>
        </label>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="primary" id="d_save">Kaydet</button>
        <button id="d_cancel">Vazgeç</button>
      </div>
    `;

    const ptSel = slot.querySelector("#d_pt");
    const contractSel = slot.querySelector("#d_contract");

    function refreshContracts(){
      contractSel.innerHTML = buildContractOptions(d.contract_id, ptSel.value);
      const exists = Array.from(contractSel.options).some(o => o.value === String(d.contract_id||""));
      if (!exists) contractSel.value = "";
    }
    refreshContracts();
    ptSel.addEventListener("change", refreshContracts);

    slot.querySelector("#d_save").addEventListener("click", () => {
      const driver_id = slot.querySelector("#d_id").value.trim();
      const full_name = slot.querySelector("#d_name").value.trim();
      const profile_type = slot.querySelector("#d_pt").value;
      const contract_id = slot.querySelector("#d_contract").value;
      const is_active = slot.querySelector("#d_active").value === "true";

      if (!driver_id) return alert("Sürücü ID zorunludur.");
      if (!full_name) return alert("Ad Soyad zorunludur.");
      if (!profile_type) return alert("Profil Tipi zorunludur.");

      if (!existing){
        const dup = state.drivers.some(x => String(x.driver_id) === String(driver_id));
        if (dup) return alert("Bu Sürücü ID zaten var: " + driver_id);
      }

      upsertDriver({driver_id, full_name, profile_type, contract_id, is_active});
      slot.innerHTML = "";
      render();
    });

    slot.querySelector("#d_cancel").addEventListener("click", () => slot.innerHTML = "");
  }

  card.querySelector("#btnAddDriver").addEventListener("click", () => openDriverForm(null));

  card.addEventListener("click", (e) => {
    const viewId = e.target?.getAttribute?.("data-view");
    const editId = e.target?.getAttribute?.("data-edit");
    const delId = e.target?.getAttribute?.("data-del");

    if (viewId){
      const d = state.drivers.find(x => String(x.driver_id) === String(viewId));
      if (!d) return;
      const c = d.contract_id ? getContract(d.contract_id) : null;
      openModal("Sürücü Görüntüle", `
        <table>
          <tr><th>Sürücü ID</th><td class="kbd">${esc(d.driver_id)}</td></tr>
          <tr><th>Ad Soyad</th><td>${esc(d.full_name)}</td></tr>
          <tr><th>Profil Tipi</th><td>${esc(ptLabel(d.profile_type))}</td></tr>
          <tr><th>Sözleşme ID</th><td class="kbd">${esc(d.contract_id||"")}</td></tr>
          <tr><th>Sözleşme Profil Tipi</th><td>${esc(c ? ptLabel(c.profile_type) : "")}</td></tr>
          <tr><th>Durum</th><td>${asBool(d.is_active) ? "Aktif" : "Pasif"}</td></tr>
        </table>
      `);
    }
    if (editId){
      const d = state.drivers.find(x => String(x.driver_id) === String(editId));
      if (!d) return;
      openDriverForm(d);
    }
    if (delId){
      if (!confirm("Sürücü silinsin mi?")) return;
      removeDriver(delId);
      render();
    }
  });

  renderTable();
  return card;
}

/* =========================
   Contracts UI
   ========================= */
function renderContracts(){
  const card = document.createElement("div");
  card.className = "card";
  const rows = state.contracts.slice().sort((a,b)=>String(a.contract_id).localeCompare(String(b.contract_id)));

  card.innerHTML = `
    <div class="row">
      <h3 style="margin:0;">Sözleşmeler</h3>
      <div style="flex:1"></div>
      <button class="primary" id="btnAddContract">Yeni Sözleşme</button>
    </div>
    <div class="small" style="margin-top:6px;">Profil Tipi + Saat/KM ücreti + Gece + TLN primleri + Not</div>
    <div id="contractFormSlot"></div>

    <div class="scroller" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Sözleşme ID</th><th>Profil Tipi</th>
            <th class="right">Saat</th><th class="right">KM</th>
            <th class="right">Gece %</th><th class="right">ADR</th>
            <th class="right">OT Eşik</th><th class="right">OT %</th>
            <th class="right">Cts %</th><th class="right">Paz %</th>
            <th>Not</th><th>İşlem</th>
          </tr>
        </thead>
        <tbody id="contractTbody"></tbody>
      </table>
    </div>
  `;

  const tbody = card.querySelector("#contractTbody");
  const slot = card.querySelector("#contractFormSlot");

  function renderTable(){
    tbody.innerHTML = "";
    for (const c of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="kbd">${esc(c.contract_id)}</td>
        <td>${esc(ptLabel(c.profile_type))}</td>
        <td class="right">${money(num(c.hour_rate_eur))}</td>
        <td class="right">${money(num(c.km_rate_eur))}</td>
        <td class="right">${fmt(num(c.night_premium_pct))}</td>
        <td class="right">${money(num(c.adr_per_km_eur))}</td>
        <td class="right">${fmt(num(c.tln_overtime_threshold_hours))}</td>
        <td class="right">${fmt(num(c.tln_overtime_pct))}</td>
        <td class="right">${fmt(num(c.tln_sat_pct))}</td>
        <td class="right">${fmt(num(c.tln_sun_pct))}</td>
        <td>${esc(c.note||"")}</td>
        <td>
          <button data-edit="${esc(c.contract_id)}">Düzenle</button>
          <button class="danger" data-del="${esc(c.contract_id)}">Sil</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function openContractForm(existing){
    const c = existing ? {...existing} : {
      contract_id:"",
      profile_type:"EMPLOYEE_TLN",
      hour_rate_eur:0,
      km_rate_eur:0,
      night_premium_pct:19,
      adr_per_km_eur:0.25,
      tln_overtime_threshold_hours:40,
      tln_overtime_pct:30,
      tln_sat_pct:50,
      tln_sun_pct:100,
      note:""
    };

    slot.innerHTML = `
      <hr/>
      <h4 style="margin:0 0 10px;">${existing ? "Sözleşme Düzenle" : "Yeni Sözleşme"}</h4>
      <div class="row">
        <label>Sözleşme ID *<br/><input id="c_id" type="text" value="${esc(c.contract_id)}" ${existing ? "disabled" : ""}></label>
        <label>Profil Tipi *<br/><select id="c_pt">${buildProfileTypeOptions(c.profile_type)}</select></label>
        <label>Saat Ücreti<br/><input id="c_hr" type="number" step="0.01" value="${esc(c.hour_rate_eur)}"></label>
        <label>KM Ücreti<br/><input id="c_km" type="number" step="0.01" value="${esc(c.km_rate_eur)}"></label>
        <label>Gece Primi %<br/><input id="c_night" type="number" step="0.01" value="${esc(c.night_premium_pct)}"></label>
        <label>ADR (€/km)<br/><input id="c_adr" type="number" step="0.01" value="${esc(c.adr_per_km_eur)}"></label>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>TLN OT Eşik (haftalık)<br/><input id="c_ot_thr" type="number" step="0.01" value="${esc(c.tln_overtime_threshold_hours)}"></label>
        <label>TLN OT %<br/><input id="c_ot_pct" type="number" step="0.01" value="${esc(c.tln_overtime_pct)}"></label>
        <label>TLN Cumartesi %<br/><input id="c_sat" type="number" step="0.01" value="${esc(c.tln_sat_pct)}"></label>
        <label>TLN Pazar %<br/><input id="c_sun" type="number" step="0.01" value="${esc(c.tln_sun_pct)}"></label>
      </div>

      <div style="margin-top:10px;">
        <label>Not<br/><textarea id="c_note">${esc(c.note||"")}</textarea></label>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="primary" id="c_save">Kaydet</button>
        <button id="c_cancel">Vazgeç</button>
      </div>
    `;

    slot.querySelector("#c_save").addEventListener("click", () => {
      const contract_id = slot.querySelector("#c_id").value.trim();
      const profile_type = slot.querySelector("#c_pt").value;
      if (!contract_id) return alert("Sözleşme ID zorunludur.");

      if (!existing){
        const dup = state.contracts.some(x => String(x.contract_id) === String(contract_id));
        if (dup) return alert("Bu Sözleşme ID zaten var: " + contract_id);
      }

      const rec = {
        contract_id,
        profile_type,
        hour_rate_eur: num(slot.querySelector("#c_hr").value),
        km_rate_eur: num(slot.querySelector("#c_km").value),
        night_premium_pct: num(slot.querySelector("#c_night").value),
        adr_per_km_eur: num(slot.querySelector("#c_adr").value),
        tln_overtime_threshold_hours: num(slot.querySelector("#c_ot_thr").value),
        tln_overtime_pct: num(slot.querySelector("#c_ot_pct").value),
        tln_sat_pct: num(slot.querySelector("#c_sat").value),
        tln_sun_pct: num(slot.querySelector("#c_sun").value),
        note: slot.querySelector("#c_note").value.trim()
      };
      upsertContract(rec);
      slot.innerHTML = "";
      render();
    });

    slot.querySelector("#c_cancel").addEventListener("click", () => slot.innerHTML = "");
  }

  card.querySelector("#btnAddContract").addEventListener("click", () => openContractForm(null));

  card.addEventListener("click", (e) => {
    const editId = e.target?.getAttribute?.("data-edit");
    const delId = e.target?.getAttribute?.("data-del");
    if (editId){
      const c = state.contracts.find(x => String(x.contract_id) === String(editId));
      if (!c) return;
      openContractForm(c);
    }
    if (delId){
      if (!confirm("Sözleşme silinsin mi?")) return;
      removeContract(delId);
      render();
    }
  });

  renderTable();
  return card;
}

/* =========================
   Tours UI (full fields)
   ========================= */
function renderTours(){
  const card = document.createElement("div");
  card.className = "card";
  const rows = state.tours.slice().sort((a,b)=>String(a.tour_id).localeCompare(String(b.tour_id)));

  card.innerHTML = `
    <div class="row">
      <h3 style="margin:0;">Turlar</h3>
      <div style="flex:1"></div>
      <button class="primary" id="btnAddTour">Yeni Tur</button>
    </div>
    <div class="small" style="margin-top:6px;">
      Tur Fiyatı = Müşteriden alınan gelir. (Charter KM maliyeti için Tur KM alanı kullanılır.)
    </div>

    <div id="tourFormSlot"></div>

    <div class="scroller" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>TURID</th>
            <th>Müşteri</th>
            <th>Tur Başlangıç Adresi</th>
            <th>Ara Duraklar</th>
            <th>Tur Bitiş Adresi</th>
            <th>Tur Başlangıç Saati</th>
            <th>Tur Bitiş Saati</th>
            <th class="right">Tur Fiyatı</th>
            <th class="right">KM</th>
            <th>Araç Tipi</th>
            <th>İşlem</th>
          </tr>
        </thead>
        <tbody id="tourTbody"></tbody>
      </table>
    </div>
  `;

  const tbody = card.querySelector("#tourTbody");
  const slot = card.querySelector("#tourFormSlot");

  function shortStops(via){
    const s = String(via||"").trim();
    if (!s) return "";
    const lines = s.split("\n").map(x=>x.trim()).filter(Boolean);
    const head = lines.slice(0,2).join(" | ");
    return lines.length > 2 ? (head + " ...") : head;
  }

  function renderTable(){
    tbody.innerHTML = "";
    for (const t of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="kbd">${esc(t.tour_id)}</td>
        <td>${esc(t.customer || "")}</td>
        <td>${esc(t.start_address || "")}</td>
        <td>${esc(shortStops(t.via_stops))}</td>
        <td>${esc(t.end_address || "")}</td>
        <td class="kbd">${esc(t.start_dt || "")}</td>
        <td class="kbd">${esc(t.end_dt || "")}</td>
        <td class="right">${money(num(t.tour_price_eur))}</td>
        <td class="right">${fmt(num(t.tour_km))}</td>
        <td>${esc(t.vehicle_type || "")}</td>
        <td>
          <button data-view="${esc(t.tour_id)}">Görüntüle</button>
          <button data-edit="${esc(t.tour_id)}">Düzenle</button>
          <button class="danger" data-del="${esc(t.tour_id)}">Sil</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function openTourForm(existing){
    const t = existing ? {...existing} : {
      tour_id:"",
      start_address:"",
      via_stops:"",
      end_address:"",
      customer:"",
      start_dt:"",
      end_dt:"",
      tour_price_eur:0,
      tour_km:0,
      vehicle_type:""
    };

    slot.innerHTML = `
      <hr/>
      <h4 style="margin:0 0 10px;">${existing ? "Tur Düzenle" : "Yeni Tur"}</h4>

      <div class="row">
        <label>TURID *<br/><input id="t_id" type="text" value="${esc(t.tour_id)}" ${existing ? "disabled" : ""}></label>
        <label>Müşteri (Customer)<br/><input id="t_customer" type="text" value="${esc(t.customer||"")}"></label>
        <label>Araç Tipi<br/><input id="t_vehicle" type="text" value="${esc(t.vehicle_type||"")}"></label>
        <label>Tur Fiyatı<br/><input id="t_price" type="number" step="0.01" value="${esc(t.tour_price_eur)}"></label>
        <label>Tur KM<br/><input id="t_km" type="number" step="0.01" value="${esc(t.tour_km||0)}"></label>
      </div>

      <div class="row" style="margin-top:10px;">
        <label style="flex:1; min-width:300px;">Tur Başlangıç Adresi<br/>
          <input id="t_start_addr" type="text" value="${esc(t.start_address||"")}" style="width:100%;">
        </label>

        <label style="flex:1; min-width:300px;">Tur Bitiş Adresi<br/>
          <input id="t_end_addr" type="text" value="${esc(t.end_address||"")}" style="width:100%;">
        </label>
      </div>

      <div style="margin-top:10px;">
        <label>Varsa Ara Duraklar (her satır 1 durak)<br/>
          <textarea id="t_via">${esc(t.via_stops||"")}</textarea>
        </label>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>Tur Başlangıç Saati<br/><input id="t_start_dt" type="datetime-local" value="${esc(t.start_dt||"")}"></label>
        <label>Tur Bitiş Saati<br/><input id="t_end_dt" type="datetime-local" value="${esc(t.end_dt||"")}"></label>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="primary" id="t_save">Kaydet</button>
        <button id="t_cancel">Vazgeç</button>
      </div>
    `;

    slot.querySelector("#t_save").addEventListener("click", () => {
      const tour_id = slot.querySelector("#t_id").value.trim();
      if (!tour_id) return alert("TURID zorunludur.");

      if (!existing){
        const dup = state.tours.some(x => String(x.tour_id) === String(tour_id));
        if (dup) return alert("Bu TURID zaten var: " + tour_id);
      }

      const start_dt = slot.querySelector("#t_start_dt").value;
      const end_dt = slot.querySelector("#t_end_dt").value;
      if (start_dt && end_dt){
        const a = new Date(start_dt);
        const b = new Date(end_dt);
        if (!isNaN(a) && !isNaN(b) && b < a){
          return alert("Tur Bitiş Saati, Başlangıç Saatinden küçük olamaz.");
        }
      }

      const rec = {
        tour_id,
        customer: slot.querySelector("#t_customer").value.trim(),
        start_address: slot.querySelector("#t_start_addr").value.trim(),
        via_stops: slot.querySelector("#t_via").value.trim(),
        end_address: slot.querySelector("#t_end_addr").value.trim(),
        start_dt,
        end_dt,
        tour_price_eur: num(slot.querySelector("#t_price").value),
        tour_km: num(slot.querySelector("#t_km").value),
        vehicle_type: slot.querySelector("#t_vehicle").value.trim()
      };

      upsertTour(rec);
      slot.innerHTML = "";
      render();
    });

    slot.querySelector("#t_cancel").addEventListener("click", () => slot.innerHTML = "");
  }

  card.querySelector("#btnAddTour").addEventListener("click", () => openTourForm(null));

  card.addEventListener("click", (e) => {
    const viewId = e.target?.getAttribute?.("data-view");
    const editId = e.target?.getAttribute?.("data-edit");
    const delId = e.target?.getAttribute?.("data-del");

    if (viewId){
      const t = state.tours.find(x => String(x.tour_id)===String(viewId));
      if (!t) return;

      const vias = String(t.via_stops||"").trim()
        ? `<ul>${String(t.via_stops).split("\n").map(x=>x.trim()).filter(Boolean).map(x=>`<li>${esc(x)}</li>`).join("")}</ul>`
        : `<span class="muted">Yok</span>`;

      openModal("Tur Görüntüle", `
        <table>
          <tr><th>TURID</th><td class="kbd">${esc(t.tour_id)}</td></tr>
          <tr><th>Müşteri</th><td>${esc(t.customer||"")}</td></tr>
          <tr><th>Tur Başlangıç Adresi</th><td>${esc(t.start_address||"")}</td></tr>
          <tr><th>Ara Duraklar</th><td>${vias}</td></tr>
          <tr><th>Tur Bitiş Adresi</th><td>${esc(t.end_address||"")}</td></tr>
          <tr><th>Tur Başlangıç Saati</th><td class="kbd">${esc(t.start_dt||"")}</td></tr>
          <tr><th>Tur Bitiş Saati</th><td class="kbd">${esc(t.end_dt||"")}</td></tr>
          <tr><th>Tur Fiyatı</th><td>${money(num(t.tour_price_eur))}</td></tr>
          <tr><th>Tur KM</th><td>${fmt(num(t.tour_km))}</td></tr>
          <tr><th>Araç Tipi</th><td>${esc(t.vehicle_type||"")}</td></tr>
        </table>
      `);
    }

    if (editId){
      const t = state.tours.find(x => String(x.tour_id)===String(editId));
      if (!t) return;
      openTourForm(t);
    }

    if (delId){
      if (!confirm("Tur silinsin mi? (Rotalardan da çıkarılır)")) return;
      removeTour(delId);
      render();
    }
  });

  renderTable();
  return card;
}

/* =========================
   Charters UI (Vendor + Vehicles)
   ========================= */
function renderCharters(){
  const card = document.createElement("div");
  card.className = "card";

  const vendors = state.charters.slice().sort((a,b)=>String(a.vendor_id).localeCompare(String(b.vendor_id)));
  const vehicles = state.charter_vehicles.slice().sort((a,b)=>String(a.vehicle_id).localeCompare(String(b.vehicle_id)));

  card.innerHTML = `
    <div class="row">
      <h3 style="margin:0;">Charterlar</h3>
      <div style="flex:1"></div>
      <button class="primary" id="btnAddVendor">Yeni Charter</button>
      <button class="primary" id="btnAddVehicle">Yeni Charter Aracı</button>
    </div>

    <div id="charterFormSlot"></div>

    <div class="grid2" style="margin-top:12px;">
      <div>
        <h4 style="margin:0 0 6px;">Charter Firmaları</h4>
        <div class="scroller" style="max-height:360px;">
          <table>
            <thead><tr><th>Charter ID</th><th>Ünvan</th><th>Durum</th><th>İşlem</th></tr></thead>
            <tbody id="vendorBody"></tbody>
          </table>
        </div>
      </div>

      <div>
        <h4 style="margin:0 0 6px;">Charter Araçları</h4>
        <div class="scroller" style="max-height:360px;">
          <table>
            <thead>
              <tr>
                <th>Araç ID</th><th>Charter</th><th>Araç</th><th>Model</th>
                <th class="right">Sabit</th><th class="right">€/km</th><th class="right">€/saat</th><th>Durum</th><th>İşlem</th>
              </tr>
            </thead>
            <tbody id="vehBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  `;

  const slot = card.querySelector("#charterFormSlot");
  const vendorBody = card.querySelector("#vendorBody");
  const vehBody = card.querySelector("#vehBody");

  function renderVendorTable(){
    vendorBody.innerHTML = "";
    for (const v of vendors){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="kbd">${esc(v.vendor_id)}</td>
        <td>${esc(v.vendor_name)}</td>
        <td>${asBool(v.is_active)?`<span class="pill">Aktif</span>`:`<span class="pill">Pasif</span>`}</td>
        <td>
          <button data-ve="${esc(v.vendor_id)}">Düzenle</button>
          <button class="danger" data-vd="${esc(v.vendor_id)}">Sil</button>
        </td>
      `;
      vendorBody.appendChild(tr);
    }
  }

  function renderVehicleTable(){
    vehBody.innerHTML = "";
    for (const v of vehicles){
      const ven = getCharter(v.vendor_id);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="kbd">${esc(v.vehicle_id)}</td>
        <td>${esc(ven ? (ven.vendor_id+" | "+ven.vendor_name) : v.vendor_id)}</td>
        <td>${esc(v.vehicle_name||"")}</td>
        <td>${esc(charterModelLabel(v.cost_model))}</td>
        <td class="right">${money(num(v.fixed_fee_eur))}</td>
        <td class="right">${money(num(v.km_rate_eur))}</td>
        <td class="right">${money(num(v.hour_rate_eur))}</td>
        <td>${asBool(v.is_active)?`<span class="pill">Aktif</span>`:`<span class="pill">Pasif</span>`}</td>
        <td>
          <button data-ce="${esc(v.vehicle_id)}">Düzenle</button>
          <button class="danger" data-cd="${esc(v.vehicle_id)}">Sil</button>
        </td>
      `;
      vehBody.appendChild(tr);
    }
  }

  function openVendorForm(existing){
    const v = existing ? {...existing} : {vendor_id:"", vendor_name:"", is_active:true};
    slot.innerHTML = `
      <hr/>
      <h4 style="margin:0 0 10px;">${existing?"Charter Düzenle":"Yeni Charter"}</h4>
      <div class="row">
        <label>Charter ID *<br/><input id="v_id" type="text" value="${esc(v.vendor_id)}" ${existing?"disabled":""}></label>
        <label>Ünvan *<br/><input id="v_name" type="text" value="${esc(v.vendor_name)}"></label>
        <label>Aktif / Pasif<br/>
          <select id="v_active">
            <option value="true" ${asBool(v.is_active)?"selected":""}>Aktif</option>
            <option value="false" ${!asBool(v.is_active)?"selected":""}>Pasif</option>
          </select>
        </label>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="primary" id="v_save">Kaydet</button>
        <button id="v_cancel">Vazgeç</button>
      </div>
    `;

    slot.querySelector("#v_save").addEventListener("click", () => {
      const vendor_id = slot.querySelector("#v_id").value.trim();
      const vendor_name = slot.querySelector("#v_name").value.trim();
      const is_active = slot.querySelector("#v_active").value==="true";
      if (!vendor_id) return alert("Charter ID zorunludur.");
      if (!vendor_name) return alert("Ünvan zorunludur.");

      if (!existing){
        const dup = state.charters.some(x=>String(x.vendor_id)===String(vendor_id));
        if (dup) return alert("Bu Charter ID zaten var: " + vendor_id);
      }
      upsertCharter({vendor_id, vendor_name, is_active});
      slot.innerHTML = "";
      render();
    });

    slot.querySelector("#v_cancel").addEventListener("click", () => slot.innerHTML = "");
  }

  function openVehicleForm(existing){
    const v = existing ? {...existing} : {
      vehicle_id:"", vendor_id:"", vehicle_name:"",
      cost_model:"FIXED", fixed_fee_eur:0, km_rate_eur:0, hour_rate_eur:0,
      is_active:true, note:""
    };

    slot.innerHTML = `
      <hr/>
      <h4 style="margin:0 0 10px;">${existing?"Charter Aracı Düzenle":"Yeni Charter Aracı"}</h4>
      <div class="row">
        <label>Araç ID *<br/><input id="cv_id" type="text" value="${esc(v.vehicle_id)}" ${existing?"disabled":""}></label>
        <label>Charter *<br/>
          <select id="cv_vendor">${buildCharterVendorOptions(v.vendor_id)}</select>
        </label>
        <label>Araç Adı *<br/><input id="cv_name" type="text" value="${esc(v.vehicle_name)}"></label>
        <label>Ücret Modeli *<br/>
          <select id="cv_model">
            ${CHARTER_COST_MODEL.map(m=>`<option value="${esc(m.code)}" ${m.code===v.cost_model?"selected":""}>${esc(m.label)}</option>`).join("")}
          </select>
        </label>
      </div>

      <div class="row" style="margin-top:10px;">
        <label id="wrap_fixed">Sabit Ücret<br/><input id="cv_fixed" type="number" step="0.01" value="${esc(v.fixed_fee_eur)}"></label>
        <label id="wrap_km">KM Ücreti (€/km)<br/><input id="cv_km" type="number" step="0.01" value="${esc(v.km_rate_eur)}"></label>
        <label id="wrap_hour">Saat Ücreti (€/saat)<br/><input id="cv_hour" type="number" step="0.01" value="${esc(v.hour_rate_eur)}"></label>
        <label>Aktif / Pasif<br/>
          <select id="cv_active">
            <option value="true" ${asBool(v.is_active)?"selected":""}>Aktif</option>
            <option value="false" ${!asBool(v.is_active)?"selected":""}>Pasif</option>
          </select>
        </label>
      </div>

      <div style="margin-top:10px;">
        <label>Not<br/><textarea id="cv_note">${esc(v.note||"")}</textarea></label>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="primary" id="cv_save">Kaydet</button>
        <button id="cv_cancel">Vazgeç</button>
      </div>
    `;

    const modelSel = slot.querySelector("#cv_model");
    const wrapFixed = slot.querySelector("#wrap_fixed");
    const wrapKm = slot.querySelector("#wrap_km");
    const wrapHour = slot.querySelector("#wrap_hour");

    function toggleWraps(){
      const m = modelSel.value;
      wrapFixed.style.display = (m==="FIXED") ? "" : "none";
      wrapKm.style.display = (m==="PER_KM") ? "" : "none";
      wrapHour.style.display = (m==="PER_HOUR") ? "" : "none";
    }
    toggleWraps();
    modelSel.addEventListener("change", toggleWraps);

    slot.querySelector("#cv_save").addEventListener("click", () => {
      const vehicle_id = slot.querySelector("#cv_id").value.trim();
      const vendor_id = slot.querySelector("#cv_vendor").value;
      const vehicle_name = slot.querySelector("#cv_name").value.trim();
      const cost_model = modelSel.value;
      const is_active = slot.querySelector("#cv_active").value==="true";

      if (!vehicle_id) return alert("Araç ID zorunludur.");
      if (!vendor_id) return alert("Charter seçiniz.");
      if (!vehicle_name) return alert("Araç adı zorunludur.");

      if (!existing){
        const dup = state.charter_vehicles.some(x=>String(x.vehicle_id)===String(vehicle_id));
        if (dup) return alert("Bu Araç ID zaten var: " + vehicle_id);
      }

      const rec = {
        vehicle_id,
        vendor_id,
        vehicle_name,
        cost_model,
        fixed_fee_eur: num(slot.querySelector("#cv_fixed").value),
        km_rate_eur: num(slot.querySelector("#cv_km").value),
        hour_rate_eur: num(slot.querySelector("#cv_hour").value),
        is_active,
        note: slot.querySelector("#cv_note").value.trim()
      };

      upsertCharterVehicle(rec);
      slot.innerHTML = "";
      render();
    });

    slot.querySelector("#cv_cancel").addEventListener("click", () => slot.innerHTML = "");
  }

  card.querySelector("#btnAddVendor").addEventListener("click", () => openVendorForm(null));
  card.querySelector("#btnAddVehicle").addEventListener("click", () => openVehicleForm(null));

  card.addEventListener("click", (e) => {
    const ve = e.target?.getAttribute?.("data-ve");
    const vd = e.target?.getAttribute?.("data-vd");
    const ce = e.target?.getAttribute?.("data-ce");
    const cd = e.target?.getAttribute?.("data-cd");

    if (ve){
      const v = state.charters.find(x=>String(x.vendor_id)===String(ve));
      if (v) openVendorForm(v);
    }
    if (vd){
      if (!confirm("Charter silinsin mi?")) return;
      removeCharter(vd);
      render();
    }
    if (ce){
      const v = state.charter_vehicles.find(x=>String(x.vehicle_id)===String(ce));
      if (v) openVehicleForm(v);
    }
    if (cd){
      if (!confirm("Charter aracı silinsin mi?")) return;
      removeCharterVehicle(cd);
      render();
    }
  });

  renderVendorTable();
  renderVehicleTable();
  return card;
}

/* =========================
   Routes UI (includes charter computed/used/override columns)
   ========================= */
function renderRoutes(){
  const card = document.createElement("div");
  card.className = "card";
  const rows = state.routes.slice().sort((a,b)=>String(a.route_no).localeCompare(String(b.route_no)));

  card.innerHTML = `
    <div class="row">
      <h3 style="margin:0;">Rotalar</h3>
      <div style="flex:1"></div>
      <button class="primary" id="btnAddRoute">Yeni Rota (NED001)</button>
    </div>

    <div class="hint small" style="margin-top:10px;">
      <b>Gelir:</b> Rota Satış override > 0 ise override, değilse turların toplamı. <br/>
      <b>Maliyet:</b> TLN/ZZP = sözleşme saat ücreti; Charter = araç modeli veya override (Evet/Hayır).
    </div>

    <div id="routeFormSlot"></div>

    <div class="scroller" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Rota No</th>
            <th>Sürücü Tipi</th>
            <th>Atama</th>
            <th class="right">Tur Adet</th>
            <th class="right">Tur Gelir</th>
            <th class="right">Gelir Kullanılan</th>

            <th class="right">Charter Hesaplanan</th>
            <th class="right">Charter Kullanılan</th>
            <th>Override?</th>

            <th class="right">Maliyet</th>
            <th class="right">Kâr</th>
            <th>İşlem</th>
          </tr>
        </thead>
        <tbody id="routeTbody"></tbody>
      </table>
    </div>
  `;

  const tbody = card.querySelector("#routeTbody");
  const slot = card.querySelector("#routeFormSlot");

  function renderTable(){
    tbody.innerHTML = "";
    for (const r of rows){
      const n = calcRouteNumbers(r);

      let assign = "";
      if (r.driver_mode==="TLN" || r.driver_mode==="ZZP"){
        const d = r.driver_id ? getDriver(r.driver_id) : null;
        assign = d ? `${d.driver_id} | ${d.full_name}` : "";
      } else {
        const ven = r.charter_vendor_id ? getCharter(r.charter_vendor_id) : null;
        const cv = r.charter_vehicle_id ? getCharterVehicle(r.charter_vehicle_id) : null;
        assign = `${ven? (ven.vendor_name) : ""}${cv? (" / "+cv.vehicle_name+" ("+charterModelLabel(cv.cost_model)+")"):""}`;
      }

      const isCharter = (r.driver_mode === "CHARTER");
      const computed = isCharter ? num(n.charter_cost_computed_eur) : null;
      const usedCharter = isCharter ? num(n.charter_cost_eur) : null;
      const overrideOn = isCharter ? asBool(r.charter_cost_override_enabled) : false;

      const p = num(n.profit_eur);
      const pCls = profitClass(p);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="kbd">${esc(r.route_no)}</td>
        <td>${esc(routeModeLabel(r.driver_mode))}</td>
        <td>${esc(assign)}</td>
        <td class="right">${(r.tour_ids||[]).length}</td>
        <td class="right">${money(n.tour_revenue_eur)}</td>
        <td class="right">${money(n.revenue_used_eur)}</td>

        <td class="right">${isCharter ? money(computed) : "-"}</td>
        <td class="right">${isCharter ? money(usedCharter) : "-"}</td>
        <td>${isCharter ? (overrideOn ? `<span class="pill tagPos">Evet</span>` : `<span class="pill">Hayır</span>`) : "-"}</td>

        <td class="right">${money(n.cost_used_eur)}</td>
        <td class="right"><span class="pill ${pCls}">${money(p)}</span></td>
        <td>
          <button data-view="${esc(r.route_no)}">Görüntüle</button>
          <button data-edit="${esc(r.route_no)}">Düzenle</button>
          <button class="danger" data-del="${esc(r.route_no)}">Sil</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function openRouteForm(existing){
    const r = existing ? {...existing} : {
      route_no:"",
      driver_mode:"CHARTER",
      driver_id:"",
      charter_vendor_id:"",
      charter_vehicle_id:"",
      charter_cost_override_enabled:false,
      charter_cost_override_eur:0,
      sales_price_eur:0,
      tour_ids:[],
      note:""
    };

    const tourRows = state.tours.slice().sort((a,b)=>String(a.tour_id).localeCompare(String(b.tour_id)));

    slot.innerHTML = `
      <hr/>
      <h4 style="margin:0 0 10px;">${existing ? "Rota Düzenle" : "Yeni Rota"}</h4>

      <div class="row">
        <label>Rota No *<br/><input id="r_no" type="text" value="${esc(r.route_no)}" ${existing ? "disabled" : ""}></label>

        <label>Kim Sürüyor? *<br/>
          <select id="r_mode">
            ${ROUTE_DRIVER_MODE.map(x=>`<option value="${esc(x.code)}" ${x.code===r.driver_mode?"selected":""}>${esc(x.label)}</option>`).join("")}
          </select>
        </label>

        <label id="wrap_driver">Sürücü (TLN/ZZP)<br/>
          <select id="r_driver"></select>
        </label>

        <label id="wrap_vendor">Charter<br/>
          <select id="r_vendor"></select>
        </label>

        <label id="wrap_vehicle">Charter Aracı<br/>
          <select id="r_vehicle"></select>
        </label>

        <label>Rota Satış (override)<br/><input id="r_sales" type="number" step="0.01" value="${esc(r.sales_price_eur)}"></label>

        <label id="wrap_override_on">Override Kullan<br/>
          <select id="r_override_on">
            <option value="false" ${asBool(r.charter_cost_override_enabled) ? "" : "selected"}>Hayır</option>
            <option value="true" ${asBool(r.charter_cost_override_enabled) ? "selected" : ""}>Evet</option>
          </select>
        </label>

        <label id="wrap_computed">Hesaplanan Charter Maliyeti<br/>
          <input id="r_computed" type="number" step="0.01" value="0" disabled>
        </label>

        <label id="wrap_override">Charter Override Maliyet<br/>
          <input id="r_override" type="number" step="0.01" value="${esc(r.charter_cost_override_eur||0)}">
        </label>
      </div>

      <div style="margin-top:10px;">
        <label>Not<br/><textarea id="r_note">${esc(r.note||"")}</textarea></label>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div>
          <h4 style="margin:0 0 8px;">Turlardan Ekle</h4>
          <div class="scroller" style="max-height:300px;">
            <table>
              <thead>
                <tr>
                  <th>Seç</th>
                  <th>TURID</th>
                  <th>Müşteri</th>
                  <th>Tur Başlangıç Adresi</th>
                  <th>Tur Bitiş Adresi</th>
                  <th>Başlangıç Saati</th>
                  <th>Bitiş Saati</th>
                  <th class="right">Tur Fiyatı</th>
                  <th class="right">KM</th>
                </tr>
              </thead>
              <tbody id="r_tourBody"></tbody>
            </table>
          </div>
        </div>

        <div>
          <h4 style="margin:0 0 8px;">Özet</h4>
          <div class="card" style="box-shadow:none;">
            <div class="row">
              <span class="pill">Tur Gelir: <b id="sum_rev">${money(0)}</b></span>
              <span class="pill">KM: <b id="sum_km">0.00</b></span>
              <span class="pill">Süre: <b id="sum_h">0.00h</b></span>
            </div>
            <div class="row" style="margin-top:8px;">
              <span class="pill">Gece: <b id="sum_n">0.00h</b></span>
              <span class="pill">Cts: <b id="sum_sat">0.00h</b></span>
              <span class="pill">Paz: <b id="sum_sun">0.00h</b></span>
            </div>
            <hr/>
            <div class="row">
              <span class="pill">Gelir Kullanılan: <b id="sum_rev_used">${money(0)}</b></span>
              <span class="pill">Maliyet: <b id="sum_cost">${money(0)}</b></span>
              <span class="pill">Kâr: <b id="sum_profit">${money(0)}</b></span>
            </div>
            <div id="kmWarn" class="warn small" style="margin-top:10px; display:none;">
              Charter KM modeli seçildi; fakat turlarda KM = 0 görünüyor. KM girmezseniz maliyet 0 hesaplanır.
            </div>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="primary" id="r_save">Kaydet</button>
        <button id="r_cancel">Vazgeç</button>
      </div>
    `;

    const modeSel = slot.querySelector("#r_mode");
    const driverSel = slot.querySelector("#r_driver");
    const vendorSel = slot.querySelector("#r_vendor");
    const vehicleSel = slot.querySelector("#r_vehicle");

    const wrapDriver = slot.querySelector("#wrap_driver");
    const wrapVendor = slot.querySelector("#wrap_vendor");
    const wrapVehicle = slot.querySelector("#wrap_vehicle");
    const wrapOverrideOn = slot.querySelector("#wrap_override_on");
    const wrapComputed = slot.querySelector("#wrap_computed");
    const wrapOverride = slot.querySelector("#wrap_override");

    const tourBody = slot.querySelector("#r_tourBody");

    function renderToursChecklist(){
      tourBody.innerHTML = "";
      for (const t of tourRows){
        const checked = (r.tour_ids||[]).some(id => String(id)===String(t.tour_id)) ? "checked" : "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="right"><input type="checkbox" data-tour="${esc(t.tour_id)}" ${checked}></td>
          <td class="kbd">${esc(t.tour_id)}</td>
          <td>${esc(t.customer||"")}</td>
          <td>${esc(t.start_address||"")}</td>
          <td>${esc(t.end_address||"")}</td>
          <td class="kbd">${esc(t.start_dt||"")}</td>
          <td class="kbd">${esc(t.end_dt||"")}</td>
          <td class="right">${money(num(t.tour_price_eur))}</td>
          <td class="right">${fmt(num(t.tour_km))}</td>
        `;
        tourBody.appendChild(tr);
      }
    }

    function refreshModeUI(){
      const m = modeSel.value;
      wrapDriver.style.display = (m==="TLN" || m==="ZZP") ? "" : "none";
      wrapVendor.style.display = (m==="CHARTER") ? "" : "none";
      wrapVehicle.style.display = (m==="CHARTER") ? "" : "none";
      wrapOverrideOn.style.display = (m==="CHARTER") ? "" : "none";
      wrapComputed.style.display = (m==="CHARTER") ? "" : "none";
      // wrapOverride görünürlüğü recomputeSummary içinde yönetilecek

      if (m==="TLN" || m==="ZZP"){
        driverSel.innerHTML = buildDriverOptionsByMode(r.driver_id, m);
      }
      if (m==="CHARTER"){
        vendorSel.innerHTML = buildCharterVendorOptions(r.charter_vendor_id);
        vehicleSel.innerHTML = buildCharterVehicleOptions(r.charter_vehicle_id, vendorSel.value || r.charter_vendor_id);
      }
    }

    function recomputeSummary(){
      const tmp = {
        ...r,
        driver_mode: modeSel.value,
        driver_id: driverSel.value,
        charter_vendor_id: vendorSel?.value || r.charter_vendor_id,
        charter_vehicle_id: vehicleSel?.value || r.charter_vehicle_id,
        charter_cost_override_enabled: slot.querySelector("#r_override_on")?.value === "true",
        charter_cost_override_eur: num(slot.querySelector("#r_override")?.value),
        sales_price_eur: num(slot.querySelector("#r_sales")?.value),
      };
      const n = calcRouteNumbers(tmp);

      slot.querySelector("#sum_rev").textContent = money(n.tour_revenue_eur);
      slot.querySelector("#sum_rev_used").textContent = money(n.revenue_used_eur);
      slot.querySelector("#sum_km").textContent = fmt(n.total_km);
      slot.querySelector("#sum_h").textContent = n.total_hours.toFixed(2) + "h";
      slot.querySelector("#sum_n").textContent = n.night_hours.toFixed(2) + "h";
      slot.querySelector("#sum_sat").textContent = n.sat_hours.toFixed(2) + "h";
      slot.querySelector("#sum_sun").textContent = n.sun_hours.toFixed(2) + "h";
      slot.querySelector("#sum_cost").textContent = money(n.cost_used_eur);
      slot.querySelector("#sum_profit").textContent = money(n.profit_eur);

      // computed alanını doldur
      const computedInput = slot.querySelector("#r_computed");
      if (computedInput) computedInput.value = fmt(n.charter_cost_computed_eur);

      // override input görünürlüğü
      const overrideOn = slot.querySelector("#r_override_on")?.value === "true";
      wrapOverride.style.display = (modeSel.value==="CHARTER" && overrideOn) ? "" : "none";

      const warn = slot.querySelector("#kmWarn");
      if (modeSel.value==="CHARTER"){
        const cv = tmp.charter_vehicle_id ? getCharterVehicle(tmp.charter_vehicle_id) : null;
        const needKm = (cv && cv.cost_model==="PER_KM");
        warn.style.display = (needKm && n.total_km<=0) ? "" : "none";
      } else {
        warn.style.display = "none";
      }
    }

    // init
    refreshModeUI();
    renderToursChecklist();
    recomputeSummary();

    modeSel.addEventListener("change", () => { refreshModeUI(); recomputeSummary(); });
    driverSel.addEventListener("change", () => { r.driver_id = driverSel.value; recomputeSummary(); });

    vendorSel.addEventListener("change", () => {
      r.charter_vendor_id = vendorSel.value;
      vehicleSel.innerHTML = buildCharterVehicleOptions("", vendorSel.value);
      r.charter_vehicle_id = "";
      recomputeSummary();
    });

    vehicleSel.addEventListener("change", () => { r.charter_vehicle_id = vehicleSel.value; recomputeSummary(); });

    slot.querySelector("#r_sales").addEventListener("input", recomputeSummary);
    slot.querySelector("#r_override_on").addEventListener("change", recomputeSummary);
    slot.querySelector("#r_override").addEventListener("input", recomputeSummary);

    tourBody.addEventListener("change", (e) => {
      const tid = e.target?.getAttribute?.("data-tour");
      if (!tid) return;
      const on = e.target.checked;
      const set = new Set(r.tour_ids || []);
      if (on) set.add(tid); else set.delete(tid);
      r.tour_ids = Array.from(set);
      recomputeSummary();
    });

    slot.querySelector("#r_save").addEventListener("click", () => {
      const route_no = slot.querySelector("#r_no").value.trim();
      if (!route_no) return alert("Rota No zorunludur (örn NED001).");

      if (!existing){
        const dup = state.routes.some(x => String(x.route_no) === String(route_no));
        if (dup) return alert("Bu Rota No zaten var: " + route_no);
      }

      const driver_mode = modeSel.value;

      const rec = {
        route_no,
        driver_mode,
        driver_id: (driver_mode==="TLN" || driver_mode==="ZZP") ? driverSel.value : "",
        charter_vendor_id: (driver_mode==="CHARTER") ? vendorSel.value : "",
        charter_vehicle_id: (driver_mode==="CHARTER") ? vehicleSel.value : "",
        charter_cost_override_enabled: (driver_mode==="CHARTER") ? (slot.querySelector("#r_override_on").value === "true") : false,
        charter_cost_override_eur: (driver_mode==="CHARTER") ? num(slot.querySelector("#r_override").value) : 0,
        sales_price_eur: num(slot.querySelector("#r_sales").value),
        tour_ids: r.tour_ids || [],
        note: slot.querySelector("#r_note").value.trim()
      };

      if (driver_mode==="CHARTER" && !rec.charter_vehicle_id){
        const ok = confirm("Charter seçtiniz ama araç seçmediniz. Yine de kaydedilsin mi?");
        if (!ok) return;
      }

      upsertRoute(rec);
      slot.innerHTML = "";
      render();
    });

    slot.querySelector("#r_cancel").addEventListener("click", () => slot.innerHTML = "");
  }

  card.querySelector("#btnAddRoute").addEventListener("click", () => openRouteForm(null));

  card.addEventListener("click", (e) => {
    const viewId = e.target?.getAttribute?.("data-view");
    const editId = e.target?.getAttribute?.("data-edit");
    const delId = e.target?.getAttribute?.("data-del");

    if (viewId){
      const r = state.routes.find(x => String(x.route_no) === String(viewId));
      if (!r) return;

      const n = calcRouteNumbers(r);

      let assignment = "";
      if (r.driver_mode==="TLN" || r.driver_mode==="ZZP"){
        const d = r.driver_id ? getDriver(r.driver_id) : null;
        assignment = d ? `${d.driver_id} | ${d.full_name}` : "";
      } else {
        const ven = r.charter_vendor_id ? getCharter(r.charter_vendor_id) : null;
        const cv = r.charter_vehicle_id ? getCharterVehicle(r.charter_vehicle_id) : null;
        assignment = `${ven? (ven.vendor_id+" | "+ven.vendor_name) : ""}${cv? (" / "+cv.vehicle_id+" | "+cv.vehicle_name+" ("+charterModelLabel(cv.cost_model)+")"):""}`;
      }

      const tourLines = (r.tour_ids||[])
        .map(id => getTour(id))
        .filter(Boolean)
        .map(t => `
          <tr>
            <td class="kbd">${esc(t.tour_id)}</td>
            <td>${esc(t.customer||"")}</td>
            <td>${esc(t.start_address||"")}</td>
            <td>${esc(t.end_address||"")}</td>
            <td class="kbd">${esc(t.start_dt||"")}</td>
            <td class="kbd">${esc(t.end_dt||"")}</td>
            <td class="right">${money(num(t.tour_price_eur))}</td>
            <td class="right">${fmt(num(t.tour_km))}</td>
            <td>${esc(t.vehicle_type||"")}</td>
          </tr>
        `).join("");

      const pCls = profitClass(num(n.profit_eur));
      const override = (r.driver_mode==="CHARTER") ? (asBool(r.charter_cost_override_enabled) ? "Evet" : "Hayır") : "-";

      openModal("Rota Görüntüle", `
        <div class="grid2">
          <div>
            <table>
              <tr><th>Rota No</th><td class="kbd">${esc(r.route_no)}</td></tr>
              <tr><th>Sürücü Tipi</th><td>${esc(routeModeLabel(r.driver_mode))}</td></tr>
              <tr><th>Atama</th><td>${esc(assignment)}</td></tr>
              <tr><th>Tur Geliri</th><td>${money(n.tour_revenue_eur)}</td></tr>
              <tr><th>Gelir Kullanılan</th><td>${money(n.revenue_used_eur)}</td></tr>
              <tr><th>Maliyet</th><td>${money(n.cost_used_eur)}</td></tr>
              <tr><th>Kâr</th><td><span class="pill ${pCls}">${money(n.profit_eur)}</span></td></tr>
              <tr><th>Marj</th><td>${num(n.margin_pct).toFixed(2)}%</td></tr>
              <tr><th>Override?</th><td>${override}</td></tr>
              <tr><th>Not</th><td>${esc(r.note||"")}</td></tr>
            </table>
          </div>
          <div>
            <table>
              <tr><th>Toplam KM</th><td>${fmt(n.total_km)}</td></tr>
              <tr><th>Toplam Süre</th><td>${n.total_hours.toFixed(2)}h</td></tr>
              <tr><th>Gece</th><td>${n.night_hours.toFixed(2)}h</td></tr>
              <tr><th>Cumartesi</th><td>${n.sat_hours.toFixed(2)}h</td></tr>
              <tr><th>Pazar</th><td>${n.sun_hours.toFixed(2)}h</td></tr>
              <tr><th>Charter Hesaplanan</th><td>${money(n.charter_cost_computed_eur)}</td></tr>
              <tr><th>Charter Kullanılan</th><td>${money(n.charter_cost_eur)}</td></tr>
            </table>
          </div>
        </div>
        <hr/>
        <h4 style="margin:0 0 8px;">Rota İçindeki Turlar</h4>
        <div class="scroller" style="max-height:320px;">
          <table>
            <thead>
              <tr>
                <th>TURID</th>
                <th>Müşteri</th>
                <th>Tur Başlangıç Adresi</th>
                <th>Tur Bitiş Adresi</th>
                <th>Başlangıç Saati</th>
                <th>Bitiş Saati</th>
                <th class="right">Tur Fiyatı</th>
                <th class="right">KM</th>
                <th>Araç Tipi</th>
              </tr>
            </thead>
            <tbody>
              ${tourLines || `<tr><td colspan="9" class="muted">Tur yok</td></tr>`}
            </tbody>
          </table>
        </div>
      `);
    }

    if (editId){
      const r = state.routes.find(x => String(x.route_no) === String(editId));
      if (!r) return;
      openRouteForm(r);
    }

    if (delId){
      if (!confirm("Rota silinsin mi?")) return;
      removeRoute(delId);
      render();
    }
  });

  renderTable();
  return card;
}

/* =========================
   Settings UI
   ========================= */
function renderSettings(){
  const card = document.createElement("div");
  card.className = "card";

  const s = mergeSettings(state.settings);

  card.innerHTML = `
    <div class="row">
      <h3 style="margin:0;">Ayarlar</h3>
      <div style="flex:1"></div>
      <span class="pill">Bu ayarlar LocalStorage’da saklanır</span>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <div class="card" style="box-shadow:none;">
        <h4 style="margin:0 0 8px;">Genel</h4>
        <div class="row">
          <label>Para Birimi Sembolü<br/><input id="set_currency" type="text" value="${esc(s.currency_symbol)}" style="width:120px;"></label>

          <label>Dashboard Varsayılan Filtre<br/>
            <select id="set_db_range">
              <option value="ALL" ${s.dashboard_default_range==="ALL"?"selected":""}>Tümü</option>
              <option value="LAST_7" ${s.dashboard_default_range==="LAST_7"?"selected":""}>Son 7 Gün</option>
              <option value="THIS_MONTH" ${s.dashboard_default_range==="THIS_MONTH"?"selected":""}>Bu Ay</option>
            </select>
          </label>

          <label>Amber Eşik (Kâr < eşik)<br/>
            <input id="set_warn" type="number" step="0.01" value="${esc(s.profit_warn_threshold)}" style="width:160px;">
          </label>
        </div>
      </div>

      <div class="card" style="box-shadow:none;">
        <h4 style="margin:0 0 8px;">Gece Aralığı</h4>
        <div class="small">Gece saatleri (cross-midnight destekli). Örn 21:00–04:00</div>
        <div class="row" style="margin-top:10px;">
          <label>Gece Başlangıç<br/><input id="set_night_start" type="time" value="${esc(s.night_start)}"></label>
          <label>Gece Bitiş<br/><input id="set_night_end" type="time" value="${esc(s.night_end)}"></label>
        </div>
        <div class="warn small" style="margin-top:10px;">
          Not: Başlangıç = Bitiş olursa gece hesabı 0 kabul edilir.
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="primary" id="set_save">Kaydet</button>
      <button id="set_defaults">Varsayılanlara Dön</button>
      <div style="flex:1"></div>
      <button id="set_export">Yedek (JSON) Dışa Aktar</button>
      <button id="set_import">Yedek (JSON) İçe Aktar</button>
      <button class="danger" id="set_reset">Tüm Veriyi Sıfırla</button>
    </div>
  `;

  function applySettings(newSettings){
    state.settings = mergeSettings(newSettings);
    saveState();
    render();
  }

  card.querySelector("#set_save").addEventListener("click", () => {
    const ns = {
      currency_symbol: card.querySelector("#set_currency").value.trim() || "€",
      dashboard_default_range: card.querySelector("#set_db_range").value,
      profit_warn_threshold: num(card.querySelector("#set_warn").value),
      night_start: card.querySelector("#set_night_start").value || "21:00",
      night_end: card.querySelector("#set_night_end").value || "04:00"
    };
    applySettings(ns);
    alert("Ayarlar kaydedildi.");
  });

  card.querySelector("#set_defaults").addEventListener("click", () => {
    if (!confirm("Varsayılan ayarlara dönülsün mü?")) return;
    applySettings(defaultSettings());
  });

  // backup actions in settings
  card.querySelector("#set_export").addEventListener("click", () => {
    downloadText(JSON.stringify(state, null, 2), "nedline_backup.json");
  });

  card.querySelector("#set_import").addEventListener("click", () => {
    const input = document.getElementById("fileInput");
    input.value = "";
    input.onchange = async () => {
      const f = input.files[0];
      if (!f) return;
      const txt = await f.text();
      try{
        const obj = JSON.parse(txt);
        if (!obj.drivers || !obj.contracts || !obj.tours) throw new Error("Format geçersiz (drivers/contracts/tours yok).");
        if (!obj.routes) obj.routes = [];
        if (!obj.charters) obj.charters = [];
        if (!obj.charter_vehicles) obj.charter_vehicles = [];
        if (!obj.settings) obj.settings = defaultSettings();
        obj.settings = mergeSettings(obj.settings);

        state = obj;
        saveState();
        alert("Yedek içe aktarıldı.");
        render();
      } catch(e){
        alert("Yedek içe aktarılamadı: " + e.message);
      }
    };
    input.click();
  });

  card.querySelector("#set_reset").addEventListener("click", () => {
    if (!confirm("Tüm veriler silinecek. Emin misiniz?")) return;
    localStorage.removeItem(STORAGE_KEY);
    loadState();
    render();
  });

  return card;
}

/* =========================
   Backup / Reset (topbar)
   ========================= */
document.getElementById("btnExport").addEventListener("click", () => {
  downloadText(JSON.stringify(state, null, 2), "nedline_backup.json");
});

document.getElementById("btnImport").addEventListener("click", () => {
  const input = document.getElementById("fileInput");
  input.value = "";
  input.onchange = async () => {
    const f = input.files[0];
    if (!f) return;
    const txt = await f.text();
    try{
      const obj = JSON.parse(txt);
      if (!obj.drivers || !obj.contracts || !obj.tours) throw new Error("Format geçersiz (drivers/contracts/tours yok).");
      if (!obj.routes) obj.routes = [];
      if (!obj.charters) obj.charters = [];
      if (!obj.charter_vehicles) obj.charter_vehicles = [];
      if (!obj.settings) obj.settings = defaultSettings();
      obj.settings = mergeSettings(obj.settings);

      state = obj;
      saveState();
      alert("Yedek içe aktarıldı.");
      render();
    } catch(e){
      alert("Yedek içe aktarılamadı: " + e.message);
    }
  };
  input.click();
});

document.getElementById("btnReset").addEventListener("click", () => {
  if (!confirm("Tüm veriler silinecek. Emin misiniz?")) return;
  localStorage.removeItem(STORAGE_KEY);
  loadState();
  render();
});

/* =========================
   Init
   ========================= */
loadState();
render();
</script>
</body>
</html>
